import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';
import { APP_INITIALIZER, Injector, NgModule } from '@angular/core';
import { InMemoryCache } from '@apollo/client/core';
import { setContext } from '@apollo/client/link/context';
import { ApolloLink } from '@apollo/client/link/core';
import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';
import { createUploadLink } from 'apollo-upload-client';
import { getAppConfig } from '../app.config';
import { introspectionResult } from '../common/introspection-result-wrapper';
import { LocalStorageService } from '../providers/local-storage/local-storage.service';
import { CheckJobsLink } from './check-jobs-link';
import { getClientDefaults } from './client-state/client-defaults';
import { clientResolvers } from './client-state/client-resolvers';
import { GET_CLIENT_STATE } from './definitions/client-definitions';
import { OmitTypenameLink } from './omit-typename-link';
import { BaseDataService } from './providers/base-data.service';
import { DataService } from './providers/data.service';
import { FetchAdapter } from './providers/fetch-adapter';
import { DefaultInterceptor } from './providers/interceptor';
import { initializeServerConfigService, ServerConfigService } from './server-config';
import { getServerLocation } from './utils/get-server-location';
import * as i0 from "@angular/core";
export function createApollo(localStorageService, fetchAdapter, injector) {
    const { adminApiPath, tokenMethod, channelTokenKey } = getAppConfig();
    const serverLocation = getServerLocation();
    const apolloCache = new InMemoryCache({
        possibleTypes: introspectionResult.possibleTypes,
        typePolicies: {
            GlobalSettings: {
                fields: {
                    serverConfig: {
                        merge: (existing, incoming) => ({ ...existing, ...incoming }),
                    },
                },
            },
            Facet: {
                fields: {
                    values: {
                        merge: (existing, incoming) => incoming,
                    },
                },
            },
        },
    });
    apolloCache.writeQuery({
        query: GET_CLIENT_STATE,
        data: getClientDefaults(localStorageService),
    });
    if (!false) {
        // TODO: enable only for dev mode
        // make the Apollo Cache inspectable in the console for debug purposes
        window['apolloCache'] = apolloCache;
    }
    return {
        link: ApolloLink.from([
            new OmitTypenameLink(),
            new CheckJobsLink(injector),
            setContext(() => {
                const headers = {};
                const channelToken = localStorageService.get('activeChannelToken');
                if (channelToken) {
                    headers[channelTokenKey ?? 'vendure-token'] = channelToken;
                }
                if (tokenMethod === 'bearer') {
                    const authToken = localStorageService.get('authToken');
                    if (authToken) {
                        headers.authorization = `Bearer ${authToken}`;
                    }
                }
                headers['Apollo-Require-Preflight'] = 'true';
                return { headers };
            }),
            createUploadLink({
                uri: `${serverLocation}/${adminApiPath}`,
                fetch: fetchAdapter.fetch,
            }),
        ]),
        cache: apolloCache,
        resolvers: clientResolvers,
    };
}
// List of all EU countries
/**
 * The DataModule is responsible for all API calls *and* serves as the source of truth for global app
 * state via the apollo-link-state package.
 */
export class DataModule {
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: DataModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule }); }
    static { this.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "14.0.0", version: "16.2.2", ngImport: i0, type: DataModule, imports: [HttpClientModule, ApolloModule] }); }
    static { this.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: DataModule, providers: [
            BaseDataService,
            DataService,
            FetchAdapter,
            ServerConfigService,
            {
                provide: APOLLO_OPTIONS,
                useFactory: createApollo,
                deps: [LocalStorageService, FetchAdapter, Injector],
            },
            { provide: HTTP_INTERCEPTORS, useClass: DefaultInterceptor, multi: true },
            {
                provide: APP_INITIALIZER,
                multi: true,
                useFactory: initializeServerConfigService,
                deps: [ServerConfigService],
            },
        ], imports: [HttpClientModule, ApolloModule] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: DataModule, decorators: [{
            type: NgModule,
            args: [{
                    imports: [HttpClientModule, ApolloModule],
                    exports: [],
                    declarations: [],
                    providers: [
                        BaseDataService,
                        DataService,
                        FetchAdapter,
                        ServerConfigService,
                        {
                            provide: APOLLO_OPTIONS,
                            useFactory: createApollo,
                            deps: [LocalStorageService, FetchAdapter, Injector],
                        },
                        { provide: HTTP_INTERCEPTORS, useClass: DefaultInterceptor, multi: true },
                        {
                            provide: APP_INITIALIZER,
                            multi: true,
                            useFactory: initializeServerConfigService,
                            deps: [ServerConfigService],
                        },
                    ],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5tb2R1bGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2RhdGEvZGF0YS5tb2R1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDM0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBdUIsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDekUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXhELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0MsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDN0UsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFFdkYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNsRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNwRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDaEUsT0FBTyxFQUFFLFdBQVcs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aWVudE1vZHVsZSwgSFRUUF9JTlRFUkNFUFRPUlMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEFQUF9JTklUSUFMSVpFUiwgSW5qZWN0b3IsIE5nTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFwb2xsb0NsaWVudE9wdGlvbnMsIEluTWVtb3J5Q2FjaGUgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9jb3JlJztcclxuaW1wb3J0IHsgc2V0Q29udGV4dCB9IGZyb20gJ0BhcG9sbG8vY2xpZW50L2xpbmsvY29udGV4dCc7XHJcbmltcG9ydCB7IEFwb2xsb0xpbmsgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9saW5rL2NvcmUnO1xyXG5pbXBvcnQgeyBBcG9sbG9Nb2R1bGUsIEFQT0xMT19PUFRJT05TIH0gZnJvbSAnYXBvbGxvLWFuZ3VsYXInO1xyXG5pbXBvcnQgeyBjcmVhdGVVcGxvYWRMaW5rIH0gZnJvbSAnYXBvbGxvLXVwbG9hZC1jbGllbnQnO1xyXG5cclxuaW1wb3J0IHsgZ2V0QXBwQ29uZmlnIH0gZnJvbSAnLi4vYXBwLmNvbmZpZyc7XHJcbmltcG9ydCB7IGludHJvc3BlY3Rpb25SZXN1bHQgfSBmcm9tICcuLi9jb21tb24vaW50cm9zcGVjdGlvbi1yZXN1bHQtd3JhcHBlcic7XHJcbmltcG9ydCB7IExvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvbG9jYWwtc3RvcmFnZS9sb2NhbC1zdG9yYWdlLnNlcnZpY2UnO1xyXG5cclxuaW1wb3J0IHsgQ2hlY2tKb2JzTGluayB9IGZyb20gJy4vY2hlY2stam9icy1saW5rJztcclxuaW1wb3J0IHsgZ2V0Q2xpZW50RGVmYXVsdHMgfSBmcm9tICcuL2NsaWVudC1zdGF0ZS9jbGllbnQtZGVmYXVsdHMnO1xyXG5pbXBvcnQgeyBjbGllbnRSZXNvbHZlcnMgfSBmcm9tICcuL2NsaWVudC1zdGF0ZS9jbGllbnQtcmVzb2x2ZXJzJztcclxuaW1wb3J0IHsgR0VUX0NMSUVOVF9TVEFURSB9IGZyb20gJy4vZGVmaW5pdGlvbnMvY2xpZW50LWRlZmluaXRpb25zJztcclxuaW1wb3J0IHsgT21pdFR5cGVuYW1lTGluayB9IGZyb20gJy4vb21pdC10eXBlbmFtZS1saW5rJztcclxuaW1wb3J0IHsgQmFzZURhdGFTZXJ2aWNlIH0gZnJvbSAnLi9wcm92aWRlcnMvYmFzZS1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBEYXRhU2VydmljZSB9IGZyb20gJy4vcHJvdmlkZXJzL2RhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IEZldGNoQWRhcHRlciB9IGZyb20gJy4vcHJvdmlkZXJzL2ZldGNoLWFkYXB0ZXInO1xyXG5pbXBvcnQgeyBEZWZhdWx0SW50ZXJjZXB0b3IgfSBmcm9tICcuL3Byb3ZpZGVycy9pbnRlcmNlcHRvcic7XHJcbmltcG9ydCB7IGluaXRpYWxpemVTZXJ2ZXJDb25maWdTZXJ2aWNlLCBTZXJ2ZXJDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2ZXItY29uZmlnJztcclxuaW1wb3J0IHsgZ2V0U2VydmVyTG9jYXRpb24gfSBmcm9tICcuL3V0aWxzL2dldC1zZXJ2ZXItbG9jYXRpb24nO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUFwb2xsbyhcclxuICAgIGxvY2FsU3RvcmFnZVNlcnZpY2U6IExvY2FsU3RvcmFnZVNlcnZpY2UsXHJcbiAgICBmZXRjaEFkYXB0ZXI6IEZldGNoQWRhcHRlcixcclxuICAgIGluamVjdG9yOiBJbmplY3RvcixcclxuKTogQXBvbGxvQ2xpZW50T3B0aW9uczxhbnk+IHtcclxuICAgIGNvbnN0IHsgYWRtaW5BcGlQYXRoLCB0b2tlbk1ldGhvZCwgY2hhbm5lbFRva2VuS2V5IH0gPSBnZXRBcHBDb25maWcoKTtcclxuICAgIGNvbnN0IHNlcnZlckxvY2F0aW9uID0gZ2V0U2VydmVyTG9jYXRpb24oKTtcclxuICAgIGNvbnN0IGFwb2xsb0NhY2hlID0gbmV3IEluTWVtb3J5Q2FjaGUoe1xyXG4gICAgICAgIHBvc3NpYmxlVHlwZXM6IGludHJvc3BlY3Rpb25SZXN1bHQucG9zc2libGVUeXBlcyxcclxuICAgICAgICB0eXBlUG9saWNpZXM6IHtcclxuICAgICAgICAgICAgR2xvYmFsU2V0dGluZ3M6IHtcclxuICAgICAgICAgICAgICAgIGZpZWxkczoge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlcnZlckNvbmZpZzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXJnZTogKGV4aXN0aW5nLCBpbmNvbWluZykgPT4gKHsgLi4uZXhpc3RpbmcsIC4uLmluY29taW5nIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBGYWNldDoge1xyXG4gICAgICAgICAgICAgICAgZmllbGRzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlOiAoZXhpc3RpbmcsIGluY29taW5nKSA9PiBpbmNvbWluZyxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgfSk7XHJcbiAgICBhcG9sbG9DYWNoZS53cml0ZVF1ZXJ5KHtcclxuICAgICAgICBxdWVyeTogR0VUX0NMSUVOVF9TVEFURSxcclxuICAgICAgICBkYXRhOiBnZXRDbGllbnREZWZhdWx0cyhsb2NhbFN0b3JhZ2VTZXJ2aWNlKSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghZmFsc2UpIHtcclxuICAgICAgICAvLyBUT0RPOiBlbmFibGUgb25seSBmb3IgZGV2IG1vZGVcclxuICAgICAgICAvLyBtYWtlIHRoZSBBcG9sbG8gQ2FjaGUgaW5zcGVjdGFibGUgaW4gdGhlIGNvbnNvbGUgZm9yIGRlYnVnIHB1cnBvc2VzXHJcbiAgICAgICAgKHdpbmRvdyBhcyBhbnkpWydhcG9sbG9DYWNoZSddID0gYXBvbGxvQ2FjaGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGxpbms6IEFwb2xsb0xpbmsuZnJvbShbXHJcbiAgICAgICAgICAgIG5ldyBPbWl0VHlwZW5hbWVMaW5rKCksXHJcbiAgICAgICAgICAgIG5ldyBDaGVja0pvYnNMaW5rKGluamVjdG9yKSxcclxuICAgICAgICAgICAgc2V0Q29udGV4dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsVG9rZW4gPSBsb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldCgnYWN0aXZlQ2hhbm5lbFRva2VuJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hhbm5lbFRva2VuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyc1tjaGFubmVsVG9rZW5LZXkgPz8gJ3ZlbmR1cmUtdG9rZW4nXSA9IGNoYW5uZWxUb2tlbjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh0b2tlbk1ldGhvZCA9PT0gJ2JlYXJlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhdXRoVG9rZW4gPSBsb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldCgnYXV0aFRva2VuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGhUb2tlbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7YXV0aFRva2VufWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaGVhZGVyc1snQXBvbGxvLVJlcXVpcmUtUHJlZmxpZ2h0J10gPSAndHJ1ZSc7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBoZWFkZXJzIH07XHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICBjcmVhdGVVcGxvYWRMaW5rKHtcclxuICAgICAgICAgICAgICAgIHVyaTogYCR7c2VydmVyTG9jYXRpb259LyR7YWRtaW5BcGlQYXRofWAsXHJcbiAgICAgICAgICAgICAgICBmZXRjaDogZmV0Y2hBZGFwdGVyLmZldGNoLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICBdKSxcclxuICAgICAgICBjYWNoZTogYXBvbGxvQ2FjaGUsXHJcbiAgICAgICAgcmVzb2x2ZXJzOiBjbGllbnRSZXNvbHZlcnMsXHJcbiAgICB9O1xyXG59XHJcblxyXG4vLyBMaXN0IG9mIGFsbCBFVSBjb3VudHJpZXNcclxuXHJcbi8qKlxyXG4gKiBUaGUgRGF0YU1vZHVsZSBpcyByZXNwb25zaWJsZSBmb3IgYWxsIEFQSSBjYWxscyAqYW5kKiBzZXJ2ZXMgYXMgdGhlIHNvdXJjZSBvZiB0cnV0aCBmb3IgZ2xvYmFsIGFwcFxyXG4gKiBzdGF0ZSB2aWEgdGhlIGFwb2xsby1saW5rLXN0YXRlIHBhY2thZ2UuXHJcbiAqL1xyXG5ATmdNb2R1bGUoe1xyXG4gICAgaW1wb3J0czogW0h0dHBDbGllbnRNb2R1bGUsIEFwb2xsb01vZHVsZV0sXHJcbiAgICBleHBvcnRzOiBbXSxcclxuICAgIGRlY2xhcmF0aW9uczogW10sXHJcbiAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBCYXNlRGF0YVNlcnZpY2UsXHJcbiAgICAgICAgRGF0YVNlcnZpY2UsXHJcbiAgICAgICAgRmV0Y2hBZGFwdGVyLFxyXG4gICAgICAgIFNlcnZlckNvbmZpZ1NlcnZpY2UsXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBwcm92aWRlOiBBUE9MTE9fT1BUSU9OUyxcclxuICAgICAgICAgICAgdXNlRmFjdG9yeTogY3JlYXRlQXBvbGxvLFxyXG4gICAgICAgICAgICBkZXBzOiBbTG9jYWxTdG9yYWdlU2VydmljZSwgRmV0Y2hBZGFwdGVyLCBJbmplY3Rvcl0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7IHByb3ZpZGU6IEhUVFBfSU5URVJDRVBUT1JTLCB1c2VDbGFzczogRGVmYXVsdEludGVyY2VwdG9yLCBtdWx0aTogdHJ1ZSB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcHJvdmlkZTogQVBQX0lOSVRJQUxJWkVSLFxyXG4gICAgICAgICAgICBtdWx0aTogdHJ1ZSxcclxuICAgICAgICAgICAgdXNlRmFjdG9yeTogaW5pdGlhbGl6ZVNlcnZlckNvbmZpZ1NlcnZpY2UsXHJcbiAgICAgICAgICAgIGRlcHM6IFtTZXJ2ZXJDb25maWdTZXJ2aWNlXSxcclxuICAgICAgICB9LFxyXG4gICAgXSxcclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFNb2R1bGUge31cclxuIl19