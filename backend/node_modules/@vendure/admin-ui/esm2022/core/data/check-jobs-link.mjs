import { ApolloLink } from '@apollo/client/core';
import { JobQueueService } from '../providers/job-queue/job-queue.service';
/**
 * This link checks each operation and if it is a mutation, it tells the JobQueueService
 * to poll for active jobs. This is because certain mutations trigger background jobs
 * which should be made known in the UI.
 */
export class CheckJobsLink extends ApolloLink {
    get jobQueueService() {
        if (!this._jobQueueService) {
            this._jobQueueService = this.injector.get(JobQueueService);
        }
        return this._jobQueueService;
    }
    /**
     * We inject the Injector rather than the JobQueueService directly in order
     * to avoid a circular dependency error.
     */
    constructor(injector) {
        super((operation, forward) => {
            if (this.isMutation(operation)) {
                this.jobQueueService.checkForJobs();
            }
            return forward ? forward(operation) : null;
        });
        this.injector = injector;
    }
    isMutation(operation) {
        return !!operation.query.definitions.find(d => d.kind === 'OperationDefinition' && d.operation === 'mutation');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2stam9icy1saW5rLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9kYXRhL2NoZWNrLWpvYnMtbGluay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFhLE1BQU0scUJBQXFCLENBQUM7QUFFNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBRTNFOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sYUFBYyxTQUFRLFVBQVU7SUFFekMsSUFBSSxlQUFlO1FBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUN4QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDOUQ7UUFDRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsWUFBb0IsUUFBa0I7UUFDbEMsS0FBSyxDQUFDLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ3pCLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDNUIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsQ0FBQzthQUN2QztZQUNELE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztRQU5hLGFBQVEsR0FBUixRQUFRLENBQVU7SUFPdEMsQ0FBQztJQUVPLFVBQVUsQ0FBQyxTQUFvQjtRQUNuQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQ3JDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxxQkFBcUIsSUFBSSxDQUFDLENBQUMsU0FBUyxLQUFLLFVBQVUsQ0FDdEUsQ0FBQztJQUNOLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFwb2xsb0xpbmssIE9wZXJhdGlvbiB9IGZyb20gJ0BhcG9sbG8vY2xpZW50L2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgSm9iUXVldWVTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL2pvYi1xdWV1ZS9qb2ItcXVldWUuc2VydmljZSc7XHJcblxyXG4vKipcclxuICogVGhpcyBsaW5rIGNoZWNrcyBlYWNoIG9wZXJhdGlvbiBhbmQgaWYgaXQgaXMgYSBtdXRhdGlvbiwgaXQgdGVsbHMgdGhlIEpvYlF1ZXVlU2VydmljZVxyXG4gKiB0byBwb2xsIGZvciBhY3RpdmUgam9icy4gVGhpcyBpcyBiZWNhdXNlIGNlcnRhaW4gbXV0YXRpb25zIHRyaWdnZXIgYmFja2dyb3VuZCBqb2JzXHJcbiAqIHdoaWNoIHNob3VsZCBiZSBtYWRlIGtub3duIGluIHRoZSBVSS5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBDaGVja0pvYnNMaW5rIGV4dGVuZHMgQXBvbGxvTGluayB7XHJcbiAgICBwcml2YXRlIF9qb2JRdWV1ZVNlcnZpY2U6IEpvYlF1ZXVlU2VydmljZTtcclxuICAgIGdldCBqb2JRdWV1ZVNlcnZpY2UoKTogSm9iUXVldWVTZXJ2aWNlIHtcclxuICAgICAgICBpZiAoIXRoaXMuX2pvYlF1ZXVlU2VydmljZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9qb2JRdWV1ZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChKb2JRdWV1ZVNlcnZpY2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5fam9iUXVldWVTZXJ2aWNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogV2UgaW5qZWN0IHRoZSBJbmplY3RvciByYXRoZXIgdGhhbiB0aGUgSm9iUXVldWVTZXJ2aWNlIGRpcmVjdGx5IGluIG9yZGVyXHJcbiAgICAgKiB0byBhdm9pZCBhIGNpcmN1bGFyIGRlcGVuZGVuY3kgZXJyb3IuXHJcbiAgICAgKi9cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICAgICAgc3VwZXIoKG9wZXJhdGlvbiwgZm9yd2FyZCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc011dGF0aW9uKG9wZXJhdGlvbikpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuam9iUXVldWVTZXJ2aWNlLmNoZWNrRm9ySm9icygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmb3J3YXJkID8gZm9yd2FyZChvcGVyYXRpb24pIDogbnVsbDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGlzTXV0YXRpb24ob3BlcmF0aW9uOiBPcGVyYXRpb24pOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gISFvcGVyYXRpb24ucXVlcnkuZGVmaW5pdGlvbnMuZmluZChcclxuICAgICAgICAgICAgZCA9PiBkLmtpbmQgPT09ICdPcGVyYXRpb25EZWZpbml0aW9uJyAmJiBkLm9wZXJhdGlvbiA9PT0gJ211dGF0aW9uJyxcclxuICAgICAgICApO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==