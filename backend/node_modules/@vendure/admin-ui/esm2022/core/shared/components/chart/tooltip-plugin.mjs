/**
 * Based on https://github.com/tmmdata/chartist-plugin-tooltip/blob/master/src/scripts/chartist-plugin-tooltip.js
 *
 */
/* global Chartist */
const defaultOptions = {
    currency: undefined,
    currencyFormatCallback: undefined,
    tooltipOffset: {
        x: 0,
        y: -20,
    },
    anchorToPoint: false,
    appendToBody: false,
    class: undefined,
    pointClass: 'ct-point',
};
export function tooltipPlugin(userOptions) {
    return function tooltip(chart) {
        const options = {
            ...defaultOptions,
            ...userOptions,
        };
        const tooltipSelector = options.pointClass;
        const $chart = chart.container;
        let $toolTip = $chart.querySelector('.chartist-tooltip');
        if (!$toolTip) {
            $toolTip = document.createElement('div');
            $toolTip.className = !options.class ? 'chartist-tooltip' : 'chartist-tooltip ' + options.class;
            if (!options.appendToBody) {
                $chart.appendChild($toolTip);
            }
            else {
                document.body.appendChild($toolTip);
            }
        }
        let height = $toolTip.offsetHeight;
        let width = $toolTip.offsetWidth;
        const points = [];
        function getClosestPoint(mouseX) {
            let closestElement = null;
            let closestDistance = Infinity;
            // Iterate through the points array to find the closest element
            for (const point of points) {
                const elementX = point.x;
                const distance = calculateDistance(mouseX, elementX);
                if (distance < closestDistance) {
                    closestElement = point.event;
                    closestDistance = distance;
                }
            }
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            return closestElement;
        }
        chart.on('draw', data => {
            if (data.type === 'point') {
                const element = data.element;
                points[data.index] = {
                    event: data,
                    x: data.element.getNode().getBoundingClientRect().x,
                };
            }
        });
        hide($toolTip);
        function on(event, selector, callback) {
            $chart.addEventListener(event, function (e) {
                if (!selector || hasClass(e.target, selector)) {
                    callback(e);
                }
            }, { passive: true });
        }
        on('mousemove', undefined, (event) => {
            const closestPoint = getClosestPoint(event.clientX);
            if (!closestPoint) {
                return;
            }
            points.forEach(point => point.event.element.removeClass('ct-tooltip-hover'));
            closestPoint.element.addClass('ct-tooltip-hover');
            const $point = closestPoint.element.getNode();
            const seriesName = 'ct:series-name';
            const meta = closestPoint.meta;
            const value = $point.getAttribute('ct:value');
            const dateFormatter = new Intl.DateTimeFormat(meta.formatOptions.locale);
            const formattedValue = meta.formatOptions.formatValueAs === 'currency'
                ? new Intl.NumberFormat(meta.formatOptions.locale, {
                    style: 'currency',
                    currency: meta.formatOptions.currencyCode,
                    minimumFractionDigits: 2,
                }).format(+(value ?? 0) / 100)
                : new Intl.NumberFormat(meta.formatOptions.locale).format(+(value ?? 0));
            const tooltipText = `
            <div class="tooltip-date">${dateFormatter.format(new Date(meta.label))}</div>
            <div class="tooltip-value">${formattedValue}</div>
           `;
            $toolTip.innerHTML = tooltipText;
            setPosition($point);
            show($toolTip);
            // Remember height and width to avoid wrong position in IE
            height = $toolTip.offsetHeight;
            width = $toolTip.offsetWidth;
        });
        on('mouseleave', undefined, () => {
            hide($toolTip);
        });
        function setPosition(element) {
            height = height || $toolTip.offsetHeight;
            width = width || $toolTip.offsetWidth;
            const { x: elX, y: elY, width: elWidth, height: elHeight } = element.getBoundingClientRect();
            const offsetX = -width / 2 + options.tooltipOffset.x;
            const offsetY = -height + options.tooltipOffset.y;
            let anchorX;
            let anchorY;
            if (!options.appendToBody) {
                const box = $chart.getBoundingClientRect();
                const left = elX - box.left - window.pageXOffset;
                const top = elY - box.top - window.pageYOffset;
                $toolTip.style.top = (anchorY || top) + offsetY + 'px';
                $toolTip.style.left = (anchorX || left) + offsetX + 'px';
            }
            else {
                $toolTip.style.top = elY + offsetY + 'px';
                $toolTip.style.left = elX + offsetX + 'px';
            }
        }
    };
}
function show(element) {
    if (!hasClass(element, 'tooltip-show')) {
        element.className = element.className + ' tooltip-show';
    }
}
function hide(element) {
    const regex = new RegExp('tooltip-show' + '\\s*', 'gi');
    element.className = element.className.replace(regex, '').trim();
}
function hasClass(element, className) {
    return (' ' + element.getAttribute('class') + ' ').indexOf(' ' + className + ' ') > -1;
}
function next(element, className) {
    do {
        element = element.nextSibling;
    } while (element && !hasClass(element, className));
    return element;
}
function text(element) {
    return element.innerText || element.textContent;
}
function calculateDistance(x1, x2) {
    return Math.abs(x2 - x1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbHRpcC1wbHVnaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3NoYXJlZC9jb21wb25lbnRzL2NoYXJ0L3Rvb2x0aXAtcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUNILHFCQUFxQjtBQUtyQixNQUFNLGNBQWMsR0FBRztJQUNuQixRQUFRLEVBQUUsU0FBUztJQUNuQixzQkFBc0IsRUFBRSxTQUFTO0lBQ2pDLGFBQWEsRUFBRTtRQUNYLENBQUMsRUFBRSxDQUFDO1FBQ0osQ0FBQyxFQUFFLENBQUMsRUFBRTtLQUNUO0lBQ0QsYUFBYSxFQUFFLEtBQUs7SUFDcEIsWUFBWSxFQUFFLEtBQUs7SUFDbkIsS0FBSyxFQUFFLFNBQVM7SUFDaEIsVUFBVSxFQUFFLFVBQVU7Q0FDekIsQ0FBQztBQUVGLE1BQU0sVUFBVSxhQUFhLENBQUMsV0FBaUI7SUFDM0MsT0FBTyxTQUFTLE9BQU8sQ0FBQyxLQUFnQjtRQUNwQyxNQUFNLE9BQU8sR0FBRztZQUNaLEdBQUcsY0FBYztZQUNqQixHQUFHLFdBQVc7U0FDakIsQ0FBQztRQUNGLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFFM0MsTUFBTSxNQUFNLEdBQUksS0FBYSxDQUFDLFNBQTJCLENBQUM7UUFDMUQsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxtQkFBbUIsQ0FBbUIsQ0FBQztRQUMzRSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ1gsUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekMsUUFBUSxDQUFDLFNBQVMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxtQkFBbUIsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1lBQy9GLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFO2dCQUN2QixNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2hDO2lCQUFNO2dCQUNILFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3ZDO1NBQ0o7UUFDRCxJQUFJLE1BQU0sR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDO1FBQ25DLElBQUksS0FBSyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUM7UUFDakMsTUFBTSxNQUFNLEdBR1AsRUFBRSxDQUFDO1FBRVIsU0FBUyxlQUFlLENBQUMsTUFBYztZQUNuQyxJQUFJLGNBQWMsR0FBcUIsSUFBSSxDQUFDO1lBQzVDLElBQUksZUFBZSxHQUFHLFFBQVEsQ0FBQztZQUUvQiwrREFBK0Q7WUFDL0QsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUU7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ3pCLE1BQU0sUUFBUSxHQUFHLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFFckQsSUFBSSxRQUFRLEdBQUcsZUFBZSxFQUFFO29CQUM1QixjQUFjLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztvQkFDN0IsZUFBZSxHQUFHLFFBQVEsQ0FBQztpQkFDOUI7YUFDSjtZQUNELG9FQUFvRTtZQUNwRSxPQUFPLGNBQWUsQ0FBQztRQUMzQixDQUFDO1FBRUQsS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDcEIsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRTtnQkFDdkIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDN0IsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRztvQkFDakIsS0FBSyxFQUFFLElBQUk7b0JBQ1gsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDO2lCQUN0RCxDQUFDO2FBQ0w7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVmLFNBQVMsRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUTtZQUNqQyxNQUFNLENBQUMsZ0JBQWdCLENBQ25CLEtBQUssRUFDTCxVQUFVLENBQUM7Z0JBQ1AsSUFBSSxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsRUFBRTtvQkFDM0MsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNmO1lBQ0wsQ0FBQyxFQUNELEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUNwQixDQUFDO1FBQ04sQ0FBQztRQUVELEVBQUUsQ0FBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLENBQUMsS0FBaUIsRUFBRSxFQUFFO1lBQzdDLE1BQU0sWUFBWSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDcEQsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDZixPQUFPO2FBQ1Y7WUFDRCxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztZQUM3RSxZQUFZLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBRWxELE1BQU0sTUFBTSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFpQixDQUFDO1lBRTdELE1BQU0sVUFBVSxHQUFHLGdCQUFnQixDQUFDO1lBQ3BDLE1BQU0sSUFBSSxHQUdOLFlBQVksQ0FBQyxJQUFJLENBQUM7WUFDdEIsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUU5QyxNQUFNLGFBQWEsR0FBRyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN6RSxNQUFNLGNBQWMsR0FDaEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEtBQUssVUFBVTtnQkFDM0MsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtvQkFDN0MsS0FBSyxFQUFFLFVBQVU7b0JBQ2pCLFFBQVEsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVk7b0JBQ3pDLHFCQUFxQixFQUFFLENBQUM7aUJBQzNCLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7Z0JBQ2hDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWpGLE1BQU0sV0FBVyxHQUFHO3dDQUNRLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO3lDQUN6QyxjQUFjO1lBQzNDLENBQUM7WUFFRCxRQUFRLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQztZQUNqQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDcEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRWYsMERBQTBEO1lBQzFELE1BQU0sR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDO1lBQy9CLEtBQUssR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLFlBQVksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFO1lBQzdCLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQixDQUFDLENBQUMsQ0FBQztRQUVILFNBQVMsV0FBVyxDQUFDLE9BQW9CO1lBQ3JDLE1BQU0sR0FBRyxNQUFNLElBQUksUUFBUSxDQUFDLFlBQVksQ0FBQztZQUN6QyxLQUFLLEdBQUcsS0FBSyxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUM7WUFDdEMsTUFBTSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxPQUFPLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUM3RixNQUFNLE9BQU8sR0FBRyxDQUFDLEtBQUssR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7WUFDckQsTUFBTSxPQUFPLEdBQUcsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7WUFDbEQsSUFBSSxPQUFPLENBQUM7WUFDWixJQUFJLE9BQU8sQ0FBQztZQUVaLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFO2dCQUN2QixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMscUJBQXFCLEVBQUUsQ0FBQztnQkFDM0MsTUFBTSxJQUFJLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztnQkFDakQsTUFBTSxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztnQkFFL0MsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQztnQkFDdkQsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQzthQUM1RDtpQkFBTTtnQkFDSCxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQztnQkFDMUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLE9BQU8sR0FBRyxJQUFJLENBQUM7YUFDOUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQUVELFNBQVMsSUFBSSxDQUFDLE9BQU87SUFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLEVBQUU7UUFDcEMsT0FBTyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxHQUFHLGVBQWUsQ0FBQztLQUMzRDtBQUNMLENBQUM7QUFFRCxTQUFTLElBQUksQ0FBQyxPQUFPO0lBQ2pCLE1BQU0sS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLGNBQWMsR0FBRyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEQsT0FBTyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDcEUsQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLE9BQU8sRUFBRSxTQUFTO0lBQ2hDLE9BQU8sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLFNBQVMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUMzRixDQUFDO0FBRUQsU0FBUyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVM7SUFDNUIsR0FBRztRQUNDLE9BQU8sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO0tBQ2pDLFFBQVEsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsRUFBRTtJQUNuRCxPQUFPLE9BQU8sQ0FBQztBQUNuQixDQUFDO0FBRUQsU0FBUyxJQUFJLENBQUMsT0FBTztJQUNqQixPQUFPLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQztBQUNwRCxDQUFDO0FBQ0QsU0FBUyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsRUFBRTtJQUM3QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0FBQzdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQmFzZWQgb24gaHR0cHM6Ly9naXRodWIuY29tL3RtbWRhdGEvY2hhcnRpc3QtcGx1Z2luLXRvb2x0aXAvYmxvYi9tYXN0ZXIvc3JjL3NjcmlwdHMvY2hhcnRpc3QtcGx1Z2luLXRvb2x0aXAuanNcclxuICpcclxuICovXHJcbi8qIGdsb2JhbCBDaGFydGlzdCAqL1xyXG5cclxuaW1wb3J0IHsgTGluZUNoYXJ0LCBQaWVDaGFydCwgRHJhd0V2ZW50IH0gZnJvbSAnY2hhcnRpc3QnO1xyXG5pbXBvcnQgeyBDaGFydEZvcm1hdE9wdGlvbnMgfSBmcm9tICcuL2NoYXJ0LmNvbXBvbmVudCc7XHJcblxyXG5jb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcclxuICAgIGN1cnJlbmN5OiB1bmRlZmluZWQsXHJcbiAgICBjdXJyZW5jeUZvcm1hdENhbGxiYWNrOiB1bmRlZmluZWQsXHJcbiAgICB0b29sdGlwT2Zmc2V0OiB7XHJcbiAgICAgICAgeDogMCxcclxuICAgICAgICB5OiAtMjAsXHJcbiAgICB9LFxyXG4gICAgYW5jaG9yVG9Qb2ludDogZmFsc2UsXHJcbiAgICBhcHBlbmRUb0JvZHk6IGZhbHNlLFxyXG4gICAgY2xhc3M6IHVuZGVmaW5lZCxcclxuICAgIHBvaW50Q2xhc3M6ICdjdC1wb2ludCcsXHJcbn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdG9vbHRpcFBsdWdpbih1c2VyT3B0aW9ucz86IGFueSkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIHRvb2x0aXAoY2hhcnQ6IExpbmVDaGFydCkge1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIC4uLmRlZmF1bHRPcHRpb25zLFxyXG4gICAgICAgICAgICAuLi51c2VyT3B0aW9ucyxcclxuICAgICAgICB9O1xyXG4gICAgICAgIGNvbnN0IHRvb2x0aXBTZWxlY3RvciA9IG9wdGlvbnMucG9pbnRDbGFzcztcclxuXHJcbiAgICAgICAgY29uc3QgJGNoYXJ0ID0gKGNoYXJ0IGFzIGFueSkuY29udGFpbmVyIGFzIEhUTUxEaXZFbGVtZW50O1xyXG4gICAgICAgIGxldCAkdG9vbFRpcCA9ICRjaGFydC5xdWVyeVNlbGVjdG9yKCcuY2hhcnRpc3QtdG9vbHRpcCcpIGFzIEhUTUxEaXZFbGVtZW50O1xyXG4gICAgICAgIGlmICghJHRvb2xUaXApIHtcclxuICAgICAgICAgICAgJHRvb2xUaXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgJHRvb2xUaXAuY2xhc3NOYW1lID0gIW9wdGlvbnMuY2xhc3MgPyAnY2hhcnRpc3QtdG9vbHRpcCcgOiAnY2hhcnRpc3QtdG9vbHRpcCAnICsgb3B0aW9ucy5jbGFzcztcclxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmFwcGVuZFRvQm9keSkge1xyXG4gICAgICAgICAgICAgICAgJGNoYXJ0LmFwcGVuZENoaWxkKCR0b29sVGlwKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoJHRvb2xUaXApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBoZWlnaHQgPSAkdG9vbFRpcC5vZmZzZXRIZWlnaHQ7XHJcbiAgICAgICAgbGV0IHdpZHRoID0gJHRvb2xUaXAub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgY29uc3QgcG9pbnRzOiBBcnJheTx7XHJcbiAgICAgICAgICAgIGV2ZW50OiBEcmF3RXZlbnQ7XHJcbiAgICAgICAgICAgIHg6IG51bWJlcjtcclxuICAgICAgICB9PiA9IFtdO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRDbG9zZXN0UG9pbnQobW91c2VYOiBudW1iZXIpOiBEcmF3RXZlbnQge1xyXG4gICAgICAgICAgICBsZXQgY2xvc2VzdEVsZW1lbnQ6IERyYXdFdmVudCB8IG51bGwgPSBudWxsO1xyXG4gICAgICAgICAgICBsZXQgY2xvc2VzdERpc3RhbmNlID0gSW5maW5pdHk7XHJcblxyXG4gICAgICAgICAgICAvLyBJdGVyYXRlIHRocm91Z2ggdGhlIHBvaW50cyBhcnJheSB0byBmaW5kIHRoZSBjbG9zZXN0IGVsZW1lbnRcclxuICAgICAgICAgICAgZm9yIChjb25zdCBwb2ludCBvZiBwb2ludHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRYID0gcG9pbnQueDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gY2FsY3VsYXRlRGlzdGFuY2UobW91c2VYLCBlbGVtZW50WCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlIDwgY2xvc2VzdERpc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xvc2VzdEVsZW1lbnQgPSBwb2ludC5ldmVudDtcclxuICAgICAgICAgICAgICAgICAgICBjbG9zZXN0RGlzdGFuY2UgPSBkaXN0YW5jZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICByZXR1cm4gY2xvc2VzdEVsZW1lbnQhO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2hhcnQub24oJ2RyYXcnLCBkYXRhID0+IHtcclxuICAgICAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ3BvaW50Jykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGRhdGEuZWxlbWVudDtcclxuICAgICAgICAgICAgICAgIHBvaW50c1tkYXRhLmluZGV4XSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudDogZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICB4OiBkYXRhLmVsZW1lbnQuZ2V0Tm9kZSgpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLngsXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGhpZGUoJHRvb2xUaXApO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBvbihldmVudCwgc2VsZWN0b3IsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICRjaGFydC5hZGRFdmVudExpc3RlbmVyKFxyXG4gICAgICAgICAgICAgICAgZXZlbnQsXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghc2VsZWN0b3IgfHwgaGFzQ2xhc3MoZS50YXJnZXQsIHNlbGVjdG9yKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgeyBwYXNzaXZlOiB0cnVlIH0sXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBvbignbW91c2Vtb3ZlJywgdW5kZWZpbmVkLCAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY2xvc2VzdFBvaW50ID0gZ2V0Q2xvc2VzdFBvaW50KGV2ZW50LmNsaWVudFgpO1xyXG4gICAgICAgICAgICBpZiAoIWNsb3Nlc3RQb2ludCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHBvaW50cy5mb3JFYWNoKHBvaW50ID0+IHBvaW50LmV2ZW50LmVsZW1lbnQucmVtb3ZlQ2xhc3MoJ2N0LXRvb2x0aXAtaG92ZXInKSk7XHJcbiAgICAgICAgICAgIGNsb3Nlc3RQb2ludC5lbGVtZW50LmFkZENsYXNzKCdjdC10b29sdGlwLWhvdmVyJyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCAkcG9pbnQgPSBjbG9zZXN0UG9pbnQuZWxlbWVudC5nZXROb2RlKCkgYXMgSFRNTEVsZW1lbnQ7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzZXJpZXNOYW1lID0gJ2N0OnNlcmllcy1uYW1lJztcclxuICAgICAgICAgICAgY29uc3QgbWV0YToge1xyXG4gICAgICAgICAgICAgICAgbGFiZWw6IHN0cmluZztcclxuICAgICAgICAgICAgICAgIGZvcm1hdE9wdGlvbnM6IENoYXJ0Rm9ybWF0T3B0aW9ucztcclxuICAgICAgICAgICAgfSA9IGNsb3Nlc3RQb2ludC5tZXRhO1xyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9ICRwb2ludC5nZXRBdHRyaWJ1dGUoJ2N0OnZhbHVlJyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRlRm9ybWF0dGVyID0gbmV3IEludGwuRGF0ZVRpbWVGb3JtYXQobWV0YS5mb3JtYXRPcHRpb25zLmxvY2FsZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm1hdHRlZFZhbHVlID1cclxuICAgICAgICAgICAgICAgIG1ldGEuZm9ybWF0T3B0aW9ucy5mb3JtYXRWYWx1ZUFzID09PSAnY3VycmVuY3knXHJcbiAgICAgICAgICAgICAgICAgICAgPyBuZXcgSW50bC5OdW1iZXJGb3JtYXQobWV0YS5mb3JtYXRPcHRpb25zLmxvY2FsZSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiAnY3VycmVuY3knLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbmN5OiBtZXRhLmZvcm1hdE9wdGlvbnMuY3VycmVuY3lDb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMixcclxuICAgICAgICAgICAgICAgICAgICAgIH0pLmZvcm1hdCgrKHZhbHVlID8/IDApIC8gMTAwKVxyXG4gICAgICAgICAgICAgICAgICAgIDogbmV3IEludGwuTnVtYmVyRm9ybWF0KG1ldGEuZm9ybWF0T3B0aW9ucy5sb2NhbGUpLmZvcm1hdCgrKHZhbHVlID8/IDApKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHRvb2x0aXBUZXh0ID0gYFxyXG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwidG9vbHRpcC1kYXRlXCI+JHtkYXRlRm9ybWF0dGVyLmZvcm1hdChuZXcgRGF0ZShtZXRhLmxhYmVsKSl9PC9kaXY+XHJcbiAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJ0b29sdGlwLXZhbHVlXCI+JHtmb3JtYXR0ZWRWYWx1ZX08L2Rpdj5cclxuICAgICAgICAgICBgO1xyXG5cclxuICAgICAgICAgICAgJHRvb2xUaXAuaW5uZXJIVE1MID0gdG9vbHRpcFRleHQ7XHJcbiAgICAgICAgICAgIHNldFBvc2l0aW9uKCRwb2ludCk7XHJcbiAgICAgICAgICAgIHNob3coJHRvb2xUaXApO1xyXG5cclxuICAgICAgICAgICAgLy8gUmVtZW1iZXIgaGVpZ2h0IGFuZCB3aWR0aCB0byBhdm9pZCB3cm9uZyBwb3NpdGlvbiBpbiBJRVxyXG4gICAgICAgICAgICBoZWlnaHQgPSAkdG9vbFRpcC5vZmZzZXRIZWlnaHQ7XHJcbiAgICAgICAgICAgIHdpZHRoID0gJHRvb2xUaXAub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIG9uKCdtb3VzZWxlYXZlJywgdW5kZWZpbmVkLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGhpZGUoJHRvb2xUaXApO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBzZXRQb3NpdGlvbihlbGVtZW50OiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgICAgICBoZWlnaHQgPSBoZWlnaHQgfHwgJHRvb2xUaXAub2Zmc2V0SGVpZ2h0O1xyXG4gICAgICAgICAgICB3aWR0aCA9IHdpZHRoIHx8ICR0b29sVGlwLm9mZnNldFdpZHRoO1xyXG4gICAgICAgICAgICBjb25zdCB7IHg6IGVsWCwgeTogZWxZLCB3aWR0aDogZWxXaWR0aCwgaGVpZ2h0OiBlbEhlaWdodCB9ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICAgICAgY29uc3Qgb2Zmc2V0WCA9IC13aWR0aCAvIDIgKyBvcHRpb25zLnRvb2x0aXBPZmZzZXQueDtcclxuICAgICAgICAgICAgY29uc3Qgb2Zmc2V0WSA9IC1oZWlnaHQgKyBvcHRpb25zLnRvb2x0aXBPZmZzZXQueTtcclxuICAgICAgICAgICAgbGV0IGFuY2hvclg7XHJcbiAgICAgICAgICAgIGxldCBhbmNob3JZO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmFwcGVuZFRvQm9keSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYm94ID0gJGNoYXJ0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGVmdCA9IGVsWCAtIGJveC5sZWZ0IC0gd2luZG93LnBhZ2VYT2Zmc2V0O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdG9wID0gZWxZIC0gYm94LnRvcCAtIHdpbmRvdy5wYWdlWU9mZnNldDtcclxuXHJcbiAgICAgICAgICAgICAgICAkdG9vbFRpcC5zdHlsZS50b3AgPSAoYW5jaG9yWSB8fCB0b3ApICsgb2Zmc2V0WSArICdweCc7XHJcbiAgICAgICAgICAgICAgICAkdG9vbFRpcC5zdHlsZS5sZWZ0ID0gKGFuY2hvclggfHwgbGVmdCkgKyBvZmZzZXRYICsgJ3B4JztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICR0b29sVGlwLnN0eWxlLnRvcCA9IGVsWSArIG9mZnNldFkgKyAncHgnO1xyXG4gICAgICAgICAgICAgICAgJHRvb2xUaXAuc3R5bGUubGVmdCA9IGVsWCArIG9mZnNldFggKyAncHgnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2hvdyhlbGVtZW50KSB7XHJcbiAgICBpZiAoIWhhc0NsYXNzKGVsZW1lbnQsICd0b29sdGlwLXNob3cnKSkge1xyXG4gICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUgKyAnIHRvb2x0aXAtc2hvdyc7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhpZGUoZWxlbWVudCkge1xyXG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKCd0b29sdGlwLXNob3cnICsgJ1xcXFxzKicsICdnaScpO1xyXG4gICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS5yZXBsYWNlKHJlZ2V4LCAnJykudHJpbSgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoYXNDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpIHtcclxuICAgIHJldHVybiAoJyAnICsgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgKyAnICcpLmluZGV4T2YoJyAnICsgY2xhc3NOYW1lICsgJyAnKSA+IC0xO1xyXG59XHJcblxyXG5mdW5jdGlvbiBuZXh0KGVsZW1lbnQsIGNsYXNzTmFtZSkge1xyXG4gICAgZG8ge1xyXG4gICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5leHRTaWJsaW5nO1xyXG4gICAgfSB3aGlsZSAoZWxlbWVudCAmJiAhaGFzQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKSk7XHJcbiAgICByZXR1cm4gZWxlbWVudDtcclxufVxyXG5cclxuZnVuY3Rpb24gdGV4dChlbGVtZW50KSB7XHJcbiAgICByZXR1cm4gZWxlbWVudC5pbm5lclRleHQgfHwgZWxlbWVudC50ZXh0Q29udGVudDtcclxufVxyXG5mdW5jdGlvbiBjYWxjdWxhdGVEaXN0YW5jZSh4MSwgeDIpIHtcclxuICAgIHJldHVybiBNYXRoLmFicyh4MiAtIHgxKTtcclxufVxyXG4iXX0=