import { toggleMark } from 'prosemirror-commands';
import { redo, undo } from 'prosemirror-history';
import { blockTypeItem, Dropdown, icons, joinUpItem, liftItem, MenuItem, selectParentNodeItem, wrapItem, } from 'prosemirror-menu';
import { wrapInList } from 'prosemirror-schema-list';
import { insertImageItem } from '../plugins/image-plugin';
import { addTable } from '../plugins/tables-plugin';
import { linkItem } from './links';
import { canInsert, IconSize, markActive, renderClarityIcon, wrapInMenuItemWithIcon } from './menu-common';
import { SubMenuWithIcon } from './sub-menu-with-icon';
function cmdItem(cmd, options) {
    const passedOptions = {
        label: options.title,
        run: cmd,
        render: options.iconShape
            ? renderClarityIcon({ shape: options.iconShape, size: IconSize.Large })
            : undefined,
    };
    // eslint-disable-next-line guard-for-in
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    if ((!options.enable || options.enable === true) && !options.select) {
        passedOptions[options.enable ? 'enable' : 'select'] = state => cmd(state);
    }
    return new MenuItem(passedOptions);
}
function markItem(markType, options) {
    const passedOptions = {
        active(state) {
            return markActive(state, markType);
        },
        enable: true,
    };
    // eslint-disable-next-line guard-for-in
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    return cmdItem(toggleMark(markType), passedOptions);
}
function wrapListItem(nodeType, options) {
    return cmdItem(wrapInList(nodeType, options.attrs), options);
}
// :: (Schema) â†’ Object
// Given a schema, look for default mark and node types in it and
// return an object with relevant menu items relating to those marks:
//
// **`toggleStrong`**`: MenuItem`
//   : A menu item to toggle the [strong mark](#schema-basic.StrongMark).
//
// **`toggleEm`**`: MenuItem`
//   : A menu item to toggle the [emphasis mark](#schema-basic.EmMark).
//
// **`toggleCode`**`: MenuItem`
//   : A menu item to toggle the [code font mark](#schema-basic.CodeMark).
//
// **`toggleLink`**`: MenuItem`
//   : A menu item to toggle the [link mark](#schema-basic.LinkMark).
//
// **`insertImage`**`: MenuItem`
//   : A menu item to insert an [image](#schema-basic.Image).
//
// **`wrapBulletList`**`: MenuItem`
//   : A menu item to wrap the selection in a [bullet list](#schema-list.BulletList).
//
// **`wrapOrderedList`**`: MenuItem`
//   : A menu item to wrap the selection in an [ordered list](#schema-list.OrderedList).
//
// **`wrapBlockQuote`**`: MenuItem`
//   : A menu item to wrap the selection in a [block quote](#schema-basic.BlockQuote).
//
// **`makeParagraph`**`: MenuItem`
//   : A menu item to set the current textblock to be a normal
//     [paragraph](#schema-basic.Paragraph).
//
// **`makeCodeBlock`**`: MenuItem`
//   : A menu item to set the current textblock to be a
//     [code block](#schema-basic.CodeBlock).
//
// **`makeHead[N]`**`: MenuItem`
//   : Where _N_ is 1 to 6. Menu items to set the current textblock to
//     be a [heading](#schema-basic.Heading) of level _N_.
//
// **`insertHorizontalRule`**`: MenuItem`
//   : A menu item to insert a horizontal rule.
//
// The return value also contains some prefabricated menu elements and
// menus, that you can use instead of composing your own menu from
// scratch:
//
// **`insertMenu`**`: Dropdown`
//   : A dropdown containing the `insertImage` and
//     `insertHorizontalRule` items.
//
// **`typeMenu`**`: Dropdown`
//   : A dropdown containing the items for making the current
//     textblock a paragraph, code block, or heading.
//
// **`fullMenu`**`: [[MenuElement]]`
//   : An array of arrays of menu elements for use as the full menu
//     for, for example the [menu bar](https://github.com/prosemirror/prosemirror-menu#user-content-menubar).
export function buildMenuItems(schema, modalService) {
    const r = {};
    let type;
    /* eslint-disable no-cond-assign */
    if ((type = schema.marks.strong)) {
        r.toggleStrong = markItem(type, {
            title: 'Toggle strong style',
            iconShape: 'bold',
        });
    }
    if ((type = schema.marks.em)) {
        r.toggleEm = markItem(type, {
            title: 'Toggle emphasis',
            iconShape: 'italic',
        });
    }
    if ((type = schema.marks.code)) {
        r.toggleCode = markItem(type, { title: 'Toggle code font', icon: icons.code });
    }
    if ((type = schema.marks.link)) {
        r.toggleLink = linkItem(type, modalService);
    }
    if ((type = schema.nodes.image)) {
        r.insertImage = insertImageItem(type, modalService);
    }
    if ((type = schema.nodes.bullet_list)) {
        r.wrapBulletList = wrapListItem(type, {
            title: 'Wrap in bullet list',
            iconShape: 'bullet-list',
        });
    }
    if ((type = schema.nodes.ordered_list)) {
        r.wrapOrderedList = wrapListItem(type, {
            title: 'Wrap in ordered list',
            iconShape: 'number-list',
        });
    }
    if ((type = schema.nodes.blockquote)) {
        r.wrapBlockQuote = wrapItem(type, {
            title: 'Wrap in block quote',
            render: renderClarityIcon({ shape: 'block-quote', size: IconSize.Large }),
        });
    }
    if ((type = schema.nodes.paragraph)) {
        r.makeParagraph = blockTypeItem(type, {
            title: 'Change to paragraph',
            render: renderClarityIcon({ shape: 'text', label: 'Plain' }),
        });
    }
    if ((type = schema.nodes.code_block)) {
        r.makeCodeBlock = blockTypeItem(type, {
            title: 'Change to code block',
            render: renderClarityIcon({ shape: 'code', label: 'Code' }),
        });
    }
    if ((type = schema.nodes.heading)) {
        for (let i = 1; i <= 10; i++) {
            r['makeHead' + i] = blockTypeItem(type, {
                title: 'Change to heading ' + i,
                label: 'Level ' + i,
                attrs: { level: i },
            });
        }
    }
    if ((type = schema.nodes.horizontal_rule)) {
        const hr = type;
        r.insertHorizontalRule = new MenuItem({
            title: 'Insert horizontal rule',
            render: view => {
                const icon = document.createElement('div');
                icon.classList.add('custom-icon', 'hr-icon');
                const labelEl = document.createElement('span');
                labelEl.textContent = 'Horizontal rule';
                return wrapInMenuItemWithIcon(icon, labelEl);
            },
            enable(state) {
                return canInsert(state, hr);
            },
            run(state, dispatch) {
                dispatch(state.tr.replaceSelectionWith(hr.create()));
            },
        });
    }
    const cut = (arr) => arr.filter(x => x);
    r.insertMenu = new Dropdown(cut([
        r.insertImage,
        r.insertHorizontalRule,
        new MenuItem({
            run: (state, dispatch) => {
                addTable(state, dispatch, {
                    rowsCount: 2,
                    colsCount: 2,
                    withHeaderRow: true,
                    cellContent: '',
                });
            },
            render: renderClarityIcon({ shape: 'table', label: 'Table' }),
        }),
    ]), { label: 'Insert' });
    r.typeMenu = new Dropdown(cut([
        r.makeParagraph,
        r.makeCodeBlock,
        r.makeHead1 &&
            new SubMenuWithIcon(cut([r.makeHead1, r.makeHead2, r.makeHead3, r.makeHead4, r.makeHead5, r.makeHead6]), {
                label: 'Heading',
                icon: () => {
                    const icon = document.createElement('div');
                    icon.textContent = 'H';
                    icon.classList.add('custom-icon', 'h-icon');
                    return icon;
                },
            }),
    ]), { label: 'Type...' });
    const inlineMenu = cut([r.toggleStrong, r.toggleEm, r.toggleLink]);
    r.inlineMenu = [inlineMenu];
    r.blockMenu = [
        cut([
            r.wrapBulletList,
            r.wrapOrderedList,
            r.wrapBlockQuote,
            joinUpItem,
            liftItem,
            selectParentNodeItem,
        ]),
    ];
    const undoRedo = [
        new MenuItem({
            title: 'Undo last change',
            run: undo,
            enable(state) {
                return undo(state);
            },
            render: renderClarityIcon({ shape: 'undo', size: IconSize.Large }),
        }),
        new MenuItem({
            title: 'Redo last undone change',
            run: redo,
            enable(state) {
                return redo(state);
            },
            render: renderClarityIcon({ shape: 'redo', size: IconSize.Large }),
        }),
    ];
    r.fullMenu = [inlineMenu].concat([[r.insertMenu, r.typeMenu]], [undoRedo], r.blockMenu);
    return r;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvc2hhcmVkL2NvbXBvbmVudHMvcmljaC10ZXh0LWVkaXRvci9wcm9zZW1pcnJvci9tZW51L21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUNILGFBQWEsRUFDYixRQUFRLEVBQ1IsS0FBSyxFQUNMLFVBQVUsRUFDVixRQUFRLEVBQ1IsUUFBUSxFQUNSLG9CQUFvQixFQUNwQixRQUFRLEdBQ1gsTUFBTSxrQkFBa0IsQ0FBQztBQUUxQixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJckQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzFELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVwRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ25DLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFNdkQsU0FBUyxPQUFPLENBQUMsR0FBNkIsRUFBRSxPQUF1QjtJQUNuRSxNQUFNLGFBQWEsR0FBRztRQUNsQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7UUFDcEIsR0FBRyxFQUFFLEdBQUc7UUFDUixNQUFNLEVBQUUsT0FBTyxDQUFDLFNBQVM7WUFDckIsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFB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QUUsSUFBSTtZQUNULE1BQU0sQ0FBQyxLQUFLO2dCQUNSLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLENBQUM7WUFDRCxNQUFNLEVBQUUsaUJBQWlCLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDckUsQ0FBQztLQUNMLENBQUM7SUFDRixDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRXhGLE9BQU8sQ0FBQyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRvZ2dsZU1hcmsgfSBmcm9tICdwcm9zZW1pcnJvci1jb21tYW5kcyc7XHJcbmltcG9ydCB7IHJlZG8sIHVuZG8gfSBmcm9tICdwcm9zZW1pcnJvci1oaXN0b3J5JztcclxuaW1wb3J0IHtcclxuICAgIGJsb2NrVHlwZUl0ZW0sXHJcbiAgICBEcm9wZG93bixcclxuICAgIGljb25zLFxyXG4gICAgam9pblVwSXRlbSxcclxuICAgIGxpZnRJdGVtLFxyXG4gICAgTWVudUl0ZW0sXHJcbiAgICBzZWxlY3RQYXJlbnROb2RlSXRlbSxcclxuICAgIHdyYXBJdGVtLFxyXG59IGZyb20gJ3Byb3NlbWlycm9yLW1lbnUnO1xyXG5pbXBvcnQgeyBNYXJrVHlwZSwgTm9kZVR5cGUsIFNjaGVtYSB9IGZyb20gJ3Byb3NlbWlycm9yLW1vZGVsJztcclxuaW1wb3J0IHsgd3JhcEluTGlzdCB9IGZyb20gJ3Byb3NlbWlycm9yLXNjaGVtYS1saXN0JztcclxuaW1wb3J0IHsgRWRpdG9yU3RhdGUgfSBmcm9tICdwcm9zZW1pcnJvci1zdGF0ZSc7XHJcblxyXG5pbXBvcnQgeyBNb2RhbFNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9wcm92aWRlcnMvbW9kYWwvbW9kYWwuc2VydmljZSc7XHJcbmltcG9ydCB7IGluc2VydEltYWdlSXRlbSB9IGZyb20gJy4uL3BsdWdpbnMvaW1hZ2UtcGx1Z2luJztcclxuaW1wb3J0IHsgYWRkVGFibGUgfSBmcm9tICcuLi9wbHVnaW5zL3RhYmxlcy1wbHVnaW4nO1xyXG5cclxuaW1wb3J0IHsgbGlua0l0ZW0gfSBmcm9tICcuL2xpbmtzJztcclxuaW1wb3J0IHsgY2FuSW5zZXJ0LCBJY29uU2l6ZSwgbWFya0FjdGl2ZSwgcmVuZGVyQ2xhcml0eUljb24sIHdyYXBJbk1lbnVJdGVtV2l0aEljb24gfSBmcm9tICcuL21lbnUtY29tbW9uJztcclxuaW1wb3J0IHsgU3ViTWVudVdpdGhJY29uIH0gZnJvbSAnLi9zdWItbWVudS13aXRoLWljb24nO1xyXG5cclxuLy8gSGVscGVycyB0byBjcmVhdGUgc3BlY2lmaWMgdHlwZXMgb2YgaXRlbXNcclxuXHJcbnR5cGUgQ21kSXRlbU9wdGlvbnMgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+ICYgeyBpY29uU2hhcGU/OiBzdHJpbmcgfTtcclxuXHJcbmZ1bmN0aW9uIGNtZEl0ZW0oY21kOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQsIG9wdGlvbnM6IENtZEl0ZW1PcHRpb25zKSB7XHJcbiAgICBjb25zdCBwYXNzZWRPcHRpb25zID0ge1xyXG4gICAgICAgIGxhYmVsOiBvcHRpb25zLnRpdGxlLFxyXG4gICAgICAgIHJ1bjogY21kLFxyXG4gICAgICAgIHJlbmRlcjogb3B0aW9ucy5pY29uU2hhcGVcclxuICAgICAgICAgICAgPyByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiBvcHRpb25zLmljb25TaGFwZSwgc2l6ZTogSWNvblNpemUuTGFyZ2UgfSlcclxuICAgICAgICAgICAgOiB1bmRlZmluZWQsXHJcbiAgICB9O1xyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGd1YXJkLWZvci1pblxyXG4gICAgZm9yIChjb25zdCBwcm9wIGluIG9wdGlvbnMpIHtcclxuICAgICAgICBwYXNzZWRPcHRpb25zW3Byb3BdID0gb3B0aW9uc1twcm9wXTtcclxuICAgIH1cclxuICAgIGlmICgoIW9wdGlvbnMuZW5hYmxlIHx8IG9wdGlvbnMuZW5hYmxlID09PSB0cnVlKSAmJiAhb3B0aW9ucy5zZWxlY3QpIHtcclxuICAgICAgICBwYXNzZWRPcHRpb25zW29wdGlvbnMuZW5hYmxlID8gJ2VuYWJsZScgOiAnc2VsZWN0J10gPSBzdGF0ZSA9PiBjbWQoc3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXcgTWVudUl0ZW0ocGFzc2VkT3B0aW9ucyBhcyBhbnkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtYXJrSXRlbShtYXJrVHlwZSwgb3B0aW9uczogQ21kSXRlbU9wdGlvbnMpIHtcclxuICAgIGNvbnN0IHBhc3NlZE9wdGlvbnMgPSB7XHJcbiAgICAgICAgYWN0aXZlKHN0YXRlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBtYXJrQWN0aXZlKHN0YXRlLCBtYXJrVHlwZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbmFibGU6IHRydWUsXHJcbiAgICB9O1xyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGd1YXJkLWZvci1pblxyXG4gICAgZm9yIChjb25zdCBwcm9wIGluIG9wdGlvbnMpIHtcclxuICAgICAgICBwYXNzZWRPcHRpb25zW3Byb3BdID0gb3B0aW9uc1twcm9wXTtcclxuICAgIH1cclxuICAgIHJldHVybiBjbWRJdGVtKHRvZ2dsZU1hcmsobWFya1R5cGUpLCBwYXNzZWRPcHRpb25zKTtcclxufVxyXG5cclxuZnVuY3Rpb24gd3JhcExpc3RJdGVtKG5vZGVUeXBlLCBvcHRpb25zOiBDbWRJdGVtT3B0aW9ucykge1xyXG4gICAgcmV0dXJuIGNtZEl0ZW0od3JhcEluTGlzdChub2RlVHlwZSwgb3B0aW9ucy5hdHRycyksIG9wdGlvbnMpO1xyXG59XHJcblxyXG4vLyA6OiAoU2NoZW1hKSDihpIgT2JqZWN0XHJcbi8vIEdpdmVuIGEgc2NoZW1hLCBsb29rIGZvciBkZWZhdWx0IG1hcmsgYW5kIG5vZGUgdHlwZXMgaW4gaXQgYW5kXHJcbi8vIHJldHVybiBhbiBvYmplY3Qgd2l0aCByZWxldmFudCBtZW51IGl0ZW1zIHJlbGF0aW5nIHRvIHRob3NlIG1hcmtzOlxyXG4vL1xyXG4vLyAqKmB0b2dnbGVTdHJvbmdgKipgOiBNZW51SXRlbWBcclxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHRvZ2dsZSB0aGUgW3N0cm9uZyBtYXJrXSgjc2NoZW1hLWJhc2ljLlN0cm9uZ01hcmspLlxyXG4vL1xyXG4vLyAqKmB0b2dnbGVFbWAqKmA6IE1lbnVJdGVtYFxyXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gdG9nZ2xlIHRoZSBbZW1waGFzaXMgbWFya10oI3NjaGVtYS1iYXNpYy5FbU1hcmspLlxyXG4vL1xyXG4vLyAqKmB0b2dnbGVDb2RlYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB0b2dnbGUgdGhlIFtjb2RlIGZvbnQgbWFya10oI3NjaGVtYS1iYXNpYy5Db2RlTWFyaykuXHJcbi8vXHJcbi8vICoqYHRvZ2dsZUxpbmtgKipgOiBNZW51SXRlbWBcclxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHRvZ2dsZSB0aGUgW2xpbmsgbWFya10oI3NjaGVtYS1iYXNpYy5MaW5rTWFyaykuXHJcbi8vXHJcbi8vICoqYGluc2VydEltYWdlYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBpbnNlcnQgYW4gW2ltYWdlXSgjc2NoZW1hLWJhc2ljLkltYWdlKS5cclxuLy9cclxuLy8gKipgd3JhcEJ1bGxldExpc3RgKipgOiBNZW51SXRlbWBcclxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHdyYXAgdGhlIHNlbGVjdGlvbiBpbiBhIFtidWxsZXQgbGlzdF0oI3NjaGVtYS1saXN0LkJ1bGxldExpc3QpLlxyXG4vL1xyXG4vLyAqKmB3cmFwT3JkZXJlZExpc3RgKipgOiBNZW51SXRlbWBcclxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHdyYXAgdGhlIHNlbGVjdGlvbiBpbiBhbiBbb3JkZXJlZCBsaXN0XSgjc2NoZW1hLWxpc3QuT3JkZXJlZExpc3QpLlxyXG4vL1xyXG4vLyAqKmB3cmFwQmxvY2tRdW90ZWAqKmA6IE1lbnVJdGVtYFxyXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gd3JhcCB0aGUgc2VsZWN0aW9uIGluIGEgW2Jsb2NrIHF1b3RlXSgjc2NoZW1hLWJhc2ljLkJsb2NrUXVvdGUpLlxyXG4vL1xyXG4vLyAqKmBtYWtlUGFyYWdyYXBoYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBzZXQgdGhlIGN1cnJlbnQgdGV4dGJsb2NrIHRvIGJlIGEgbm9ybWFsXHJcbi8vICAgICBbcGFyYWdyYXBoXSgjc2NoZW1hLWJhc2ljLlBhcmFncmFwaCkuXHJcbi8vXHJcbi8vICoqYG1ha2VDb2RlQmxvY2tgKipgOiBNZW51SXRlbWBcclxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHNldCB0aGUgY3VycmVudCB0ZXh0YmxvY2sgdG8gYmUgYVxyXG4vLyAgICAgW2NvZGUgYmxvY2tdKCNzY2hlbWEtYmFzaWMuQ29kZUJsb2NrKS5cclxuLy9cclxuLy8gKipgbWFrZUhlYWRbTl1gKipgOiBNZW51SXRlbWBcclxuLy8gICA6IFdoZXJlIF9OXyBpcyAxIHRvIDYuIE1lbnUgaXRlbXMgdG8gc2V0IHRoZSBjdXJyZW50IHRleHRibG9jayB0b1xyXG4vLyAgICAgYmUgYSBbaGVhZGluZ10oI3NjaGVtYS1iYXNpYy5IZWFkaW5nKSBvZiBsZXZlbCBfTl8uXHJcbi8vXHJcbi8vICoqYGluc2VydEhvcml6b250YWxSdWxlYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBpbnNlcnQgYSBob3Jpem9udGFsIHJ1bGUuXHJcbi8vXHJcbi8vIFRoZSByZXR1cm4gdmFsdWUgYWxzbyBjb250YWlucyBzb21lIHByZWZhYnJpY2F0ZWQgbWVudSBlbGVtZW50cyBhbmRcclxuLy8gbWVudXMsIHRoYXQgeW91IGNhbiB1c2UgaW5zdGVhZCBvZiBjb21wb3NpbmcgeW91ciBvd24gbWVudSBmcm9tXHJcbi8vIHNjcmF0Y2g6XHJcbi8vXHJcbi8vICoqYGluc2VydE1lbnVgKipgOiBEcm9wZG93bmBcclxuLy8gICA6IEEgZHJvcGRvd24gY29udGFpbmluZyB0aGUgYGluc2VydEltYWdlYCBhbmRcclxuLy8gICAgIGBpbnNlcnRIb3Jpem9udGFsUnVsZWAgaXRlbXMuXHJcbi8vXHJcbi8vICoqYHR5cGVNZW51YCoqYDogRHJvcGRvd25gXHJcbi8vICAgOiBBIGRyb3Bkb3duIGNvbnRhaW5pbmcgdGhlIGl0ZW1zIGZvciBtYWtpbmcgdGhlIGN1cnJlbnRcclxuLy8gICAgIHRleHRibG9jayBhIHBhcmFncmFwaCwgY29kZSBibG9jaywgb3IgaGVhZGluZy5cclxuLy9cclxuLy8gKipgZnVsbE1lbnVgKipgOiBbW01lbnVFbGVtZW50XV1gXHJcbi8vICAgOiBBbiBhcnJheSBvZiBhcnJheXMgb2YgbWVudSBlbGVtZW50cyBmb3IgdXNlIGFzIHRoZSBmdWxsIG1lbnVcclxuLy8gICAgIGZvciwgZm9yIGV4YW1wbGUgdGhlIFttZW51IGJhcl0oaHR0cHM6Ly9naXRodWIuY29tL3Byb3NlbWlycm9yL3Byb3NlbWlycm9yLW1lbnUjdXNlci1jb250ZW50LW1lbnViYXIpLlxyXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRNZW51SXRlbXMoc2NoZW1hOiBTY2hlbWEsIG1vZGFsU2VydmljZTogTW9kYWxTZXJ2aWNlKSB7XHJcbiAgICBjb25zdCByOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgICBsZXQgdHlwZTogTWFya1R5cGUgfCBOb2RlVHlwZTtcclxuICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWNvbmQtYXNzaWduICovXHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubWFya3Muc3Ryb25nKSkge1xyXG4gICAgICAgIHIudG9nZ2xlU3Ryb25nID0gbWFya0l0ZW0odHlwZSwge1xyXG4gICAgICAgICAgICB0aXRsZTogJ1RvZ2dsZSBzdHJvbmcgc3R5bGUnLFxyXG4gICAgICAgICAgICBpY29uU2hhcGU6ICdib2xkJyxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5tYXJrcy5lbSkpIHtcclxuICAgICAgICByLnRvZ2dsZUVtID0gbWFya0l0ZW0odHlwZSwge1xyXG4gICAgICAgICAgICB0aXRsZTogJ1RvZ2dsZSBlbXBoYXNpcycsXHJcbiAgICAgICAgICAgIGljb25TaGFwZTogJ2l0YWxpYycsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubWFya3MuY29kZSkpIHtcclxuICAgICAgICByLnRvZ2dsZUNvZGUgPSBtYXJrSXRlbSh0eXBlLCB7IHRpdGxlOiAnVG9nZ2xlIGNvZGUgZm9udCcsIGljb246IGljb25zLmNvZGUgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubWFya3MubGluaykpIHtcclxuICAgICAgICByLnRvZ2dsZUxpbmsgPSBsaW5rSXRlbSh0eXBlLCBtb2RhbFNlcnZpY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5pbWFnZSkpIHtcclxuICAgICAgICByLmluc2VydEltYWdlID0gaW5zZXJ0SW1hZ2VJdGVtKHR5cGUsIG1vZGFsU2VydmljZSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuYnVsbGV0X2xpc3QpKSB7XHJcbiAgICAgICAgci53cmFwQnVsbGV0TGlzdCA9IHdyYXBMaXN0SXRlbSh0eXBlLCB7XHJcbiAgICAgICAgICAgIHRpdGxlOiAnV3JhcCBpbiBidWxsZXQgbGlzdCcsXHJcbiAgICAgICAgICAgIGljb25TaGFwZTogJ2J1bGxldC1saXN0JyxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5vcmRlcmVkX2xpc3QpKSB7XHJcbiAgICAgICAgci53cmFwT3JkZXJlZExpc3QgPSB3cmFwTGlzdEl0ZW0odHlwZSwge1xyXG4gICAgICAgICAgICB0aXRsZTogJ1dyYXAgaW4gb3JkZXJlZCBsaXN0JyxcclxuICAgICAgICAgICAgaWNvblNoYXBlOiAnbnVtYmVyLWxpc3QnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmJsb2NrcXVvdGUpKSB7XHJcbiAgICAgICAgci53cmFwQmxvY2tRdW90ZSA9IHdyYXBJdGVtKHR5cGUsIHtcclxuICAgICAgICAgICAgdGl0bGU6ICdXcmFwIGluIGJsb2NrIHF1b3RlJyxcclxuICAgICAgICAgICAgcmVuZGVyOiByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiAnYmxvY2stcXVvdGUnLCBzaXplOiBJY29uU2l6ZS5MYXJnZSB9KSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5wYXJhZ3JhcGgpKSB7XHJcbiAgICAgICAgci5tYWtlUGFyYWdyYXBoID0gYmxvY2tUeXBlSXRlbSh0eXBlLCB7XHJcbiAgICAgICAgICAgIHRpdGxlOiAnQ2hhbmdlIHRvIHBhcmFncmFwaCcsXHJcbiAgICAgICAgICAgIHJlbmRlcjogcmVuZGVyQ2xhcml0eUljb24oeyBzaGFwZTogJ3RleHQnLCBsYWJlbDogJ1BsYWluJyB9KSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5jb2RlX2Jsb2NrKSkge1xyXG4gICAgICAgIHIubWFrZUNvZGVCbG9jayA9IGJsb2NrVHlwZUl0ZW0odHlwZSwge1xyXG4gICAgICAgICAgICB0aXRsZTogJ0NoYW5nZSB0byBjb2RlIGJsb2NrJyxcclxuICAgICAgICAgICAgcmVuZGVyOiByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiAnY29kZScsIGxhYmVsOiAnQ29kZScgfSksXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuaGVhZGluZykpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSAxMDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHJbJ21ha2VIZWFkJyArIGldID0gYmxvY2tUeXBlSXRlbSh0eXBlLCB7XHJcbiAgICAgICAgICAgICAgICB0aXRsZTogJ0NoYW5nZSB0byBoZWFkaW5nICcgKyBpLFxyXG4gICAgICAgICAgICAgICAgbGFiZWw6ICdMZXZlbCAnICsgaSxcclxuICAgICAgICAgICAgICAgIGF0dHJzOiB7IGxldmVsOiBpIH0sXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5ob3Jpem9udGFsX3J1bGUpKSB7XHJcbiAgICAgICAgY29uc3QgaHIgPSB0eXBlO1xyXG4gICAgICAgIHIuaW5zZXJ0SG9yaXpvbnRhbFJ1bGUgPSBuZXcgTWVudUl0ZW0oe1xyXG4gICAgICAgICAgICB0aXRsZTogJ0luc2VydCBob3Jpem9udGFsIHJ1bGUnLFxyXG4gICAgICAgICAgICByZW5kZXI6IHZpZXcgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaWNvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgICAgICAgICAgaWNvbi5jbGFzc0xpc3QuYWRkKCdjdXN0b20taWNvbicsICdoci1pY29uJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgICAgICAgICAgbGFiZWxFbC50ZXh0Q29udGVudCA9ICdIb3Jpem9udGFsIHJ1bGUnO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdyYXBJbk1lbnVJdGVtV2l0aEljb24oaWNvbiwgbGFiZWxFbCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGVuYWJsZShzdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbkluc2VydChzdGF0ZSwgaHIpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBydW4oc3RhdGU6IEVkaXRvclN0YXRlLCBkaXNwYXRjaCkge1xyXG4gICAgICAgICAgICAgICAgZGlzcGF0Y2goc3RhdGUudHIucmVwbGFjZVNlbGVjdGlvbldpdGgoaHIuY3JlYXRlKCkpKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjdXQgPSA8VD4oYXJyOiBUW10pOiBUW10gPT4gYXJyLmZpbHRlcih4ID0+IHgpO1xyXG4gICAgci5pbnNlcnRNZW51ID0gbmV3IERyb3Bkb3duKFxyXG4gICAgICAgIGN1dChbXHJcbiAgICAgICAgICAgIHIuaW5zZXJ0SW1hZ2UsXHJcbiAgICAgICAgICAgIHIuaW5zZXJ0SG9yaXpvbnRhbFJ1bGUsXHJcbiAgICAgICAgICAgIG5ldyBNZW51SXRlbSh7XHJcbiAgICAgICAgICAgICAgICBydW46IChzdGF0ZSwgZGlzcGF0Y2gpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBhZGRUYWJsZShzdGF0ZSwgZGlzcGF0Y2gsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93c0NvdW50OiAyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xzQ291bnQ6IDIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGhIZWFkZXJSb3c6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGxDb250ZW50OiAnJyxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICd0YWJsZScsIGxhYmVsOiAnVGFibGUnIH0pLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICBdKSxcclxuICAgICAgICB7IGxhYmVsOiAnSW5zZXJ0JyB9LFxyXG4gICAgKTtcclxuICAgIHIudHlwZU1lbnUgPSBuZXcgRHJvcGRvd24oXHJcbiAgICAgICAgY3V0KFtcclxuICAgICAgICAgICAgci5tYWtlUGFyYWdyYXBoLFxyXG4gICAgICAgICAgICByLm1ha2VDb2RlQmxvY2ssXHJcbiAgICAgICAgICAgIHIubWFrZUhlYWQxICYmXHJcbiAgICAgICAgICAgICAgICBuZXcgU3ViTWVudVdpdGhJY29uKFxyXG4gICAgICAgICAgICAgICAgICAgIGN1dChbci5tYWtlSGVhZDEsIHIubWFrZUhlYWQyLCByLm1ha2VIZWFkMywgci5tYWtlSGVhZDQsIHIubWFrZUhlYWQ1LCByLm1ha2VIZWFkNl0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICdIZWFkaW5nJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWNvbjogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaWNvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbi50ZXh0Q29udGVudCA9ICdIJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb24uY2xhc3NMaXN0LmFkZCgnY3VzdG9tLWljb24nLCAnaC1pY29uJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWNvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgKSxcclxuICAgICAgICBdKSxcclxuICAgICAgICB7IGxhYmVsOiAnVHlwZS4uLicgfSxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgaW5saW5lTWVudSA9IGN1dChbci50b2dnbGVTdHJvbmcsIHIudG9nZ2xlRW0sIHIudG9nZ2xlTGlua10pO1xyXG4gICAgci5pbmxpbmVNZW51ID0gW2lubGluZU1lbnVdO1xyXG4gICAgci5ibG9ja01lbnUgPSBbXHJcbiAgICAgICAgY3V0KFtcclxuICAgICAgICAgICAgci53cmFwQnVsbGV0TGlzdCxcclxuICAgICAgICAgICAgci53cmFwT3JkZXJlZExpc3QsXHJcbiAgICAgICAgICAgIHIud3JhcEJsb2NrUXVvdGUsXHJcbiAgICAgICAgICAgIGpvaW5VcEl0ZW0sXHJcbiAgICAgICAgICAgIGxpZnRJdGVtLFxyXG4gICAgICAgICAgICBzZWxlY3RQYXJlbnROb2RlSXRlbSxcclxuICAgICAgICBdKSxcclxuICAgIF07XHJcbiAgICBjb25zdCB1bmRvUmVkbyA9IFtcclxuICAgICAgICBuZXcgTWVudUl0ZW0oe1xyXG4gICAgICAgICAgICB0aXRsZTogJ1VuZG8gbGFzdCBjaGFuZ2UnLFxyXG4gICAgICAgICAgICBydW46IHVuZG8sXHJcbiAgICAgICAgICAgIGVuYWJsZShzdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZG8oc3RhdGUpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICd1bmRvJywgc2l6ZTogSWNvblNpemUuTGFyZ2UgfSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgbmV3IE1lbnVJdGVtKHtcclxuICAgICAgICAgICAgdGl0bGU6ICdSZWRvIGxhc3QgdW5kb25lIGNoYW5nZScsXHJcbiAgICAgICAgICAgIHJ1bjogcmVkbyxcclxuICAgICAgICAgICAgZW5hYmxlKHN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVkbyhzdGF0ZSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlbmRlcjogcmVuZGVyQ2xhcml0eUljb24oeyBzaGFwZTogJ3JlZG8nLCBzaXplOiBJY29uU2l6ZS5MYXJnZSB9KSxcclxuICAgICAgICB9KSxcclxuICAgIF07XHJcbiAgICByLmZ1bGxNZW51ID0gW2lubGluZU1lbnVdLmNvbmNhdChbW3IuaW5zZXJ0TWVudSwgci50eXBlTWVudV1dLCBbdW5kb1JlZG9dLCByLmJsb2NrTWVudSk7XHJcblxyXG4gICAgcmV0dXJuIHI7XHJcbn1cclxuIl19