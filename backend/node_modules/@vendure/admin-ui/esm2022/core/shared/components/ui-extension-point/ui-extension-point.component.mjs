import { ChangeDetectionStrategy, Component, HostBinding, Input, isDevMode, ViewChild, } from '@angular/core';
import { CodeJar } from 'codejar';
import { tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../../../data/providers/data.service";
import * as i2 from "@clr/angular";
import * as i3 from "@angular/common";
import * as i4 from "../dropdown/dropdown.component";
import * as i5 from "../dropdown/dropdown-menu.component";
import * as i6 from "../dropdown/dropdown-trigger.directive";
export class UiExtensionPointComponent {
    constructor(dataService) {
        this.dataService = dataService;
        this.display = 'inline-block';
        this.isDevMode = isDevMode();
    }
    getCodeTemplate(api) {
        return codeTemplates[api](this.locationId, this.metadata).trim();
    }
    ngOnInit() {
        this.display$ = this.dataService.client
            .uiState()
            .mapStream(({ uiState }) => uiState.displayUiExtensionPoints)
            .pipe(tap(display => {
            if (display) {
                setTimeout(() => {
                    const highlight = (editor) => {
                        const code = editor.textContent ?? '';
                        editor.innerHTML = highlightTsCode(this.getCodeTemplate(this.api));
                    };
                    this.editorElementRef.nativeElement.contentEditable = 'false';
                    this.jar = CodeJar(this.editorElementRef.nativeElement, highlight);
                    this.jar.updateCode(this.getCodeTemplate(this.api));
                });
            }
        }));
    }
    ngAfterViewInit() {
        // this.dropdownComponent.onOpenChange(isOpen => {
        //     if (isOpen) {
        //     }
        // });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: UiExtensionPointComponent, deps: [{ token: i1.DataService }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.2", type: UiExtensionPointComponent, selector: "vdr-ui-extension-point", inputs: { locationId: "locationId", metadata: "metadata", topPx: "topPx", leftPx: "leftPx", display: "display", api: "api" }, host: { properties: { "style.display": "this.display" } }, viewQueries: [{ propertyName: "editorElementRef", first: true, predicate: ["editor"], descendants: true }, { propertyName: "dropdownComponent", first: true, predicate: ["dropdownComponent"], descendants: true }], ngImport: i0, template: "<div [class.highlight]=\"isDevMode && (display$ | async)\" class=\"wrapper\" [style.display]=\"display\">\r\n    <vdr-dropdown *ngIf=\"isDevMode && (display$ | async)\" #dropdownComponent>\r\n        <button class=\"extension-point-info-trigger\"\r\n                [style.top.px]=\"topPx ?? 0\"\r\n                [style.left.px]=\"leftPx ?? 0\"\r\n                vdrDropdownTrigger>\r\n            <clr-icon shape=\"plugin\" class=\"\" size=\"12\"></clr-icon>\r\n        </button>\r\n        <vdr-dropdown-menu>\r\n            <div #editor contenteditable=\"false\" class=\"highlighted\"></div>\r\n        </vdr-dropdown-menu>\r\n    </vdr-dropdown>\r\n    <ng-content></ng-content>\r\n</div>\r\n", styles: [":host{position:relative}.wrapper{height:100%}button.extension-point-info-trigger{position:absolute;background-color:var(--color-accent-500);border-radius:50%;width:22px;height:22px;border:0;margin:0;padding:0;z-index:100;display:flex;align-items:center;justify-content:center;opacity:.8}button.extension-point-info-trigger:hover{opacity:1}button.extension-point-info-trigger clr-icon{color:#fff}.extension-info{padding:12px}pre{padding:6px;font-family:Source Code Pro,Lucida Console,Monaco,monospace;background-color:var(--color-grey-200)}::ng-deep .highlighted{margin:calc(var(--space-unit) * 2);padding:calc(var(--space-unit) * 2);border:1px solid var(--color-grey-300);border-radius:var(--border-radius);background-color:var(--color-component-bg-200);font-family:Source Code Pro,Lucida Console,Monaco,monospace;color:var(--color-json-editor-text)}::ng-deep .highlighted .ts-string{color:var(--color-accent-600)}::ng-deep .highlighted .ts-comment{color:var(--color-grey-500)}::ng-deep .highlighted .ts-keyword{color:var(--color-json-editor-key)}::ng-deep .highlighted .ts-default{color:var(--color-json-editor-text)}\n"], dependencies: [{ kind: "directive", type: i2.ClrIconCustomTag, selector: "clr-icon" }, { kind: "directive", type: i3.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i4.DropdownComponent, selector: "vdr-dropdown", inputs: ["manualToggle"] }, { kind: "component", type: i5.DropdownMenuComponent, selector: "vdr-dropdown-menu", inputs: ["vdrPosition", "customClasses"] }, { kind: "directive", type: i6.DropdownTriggerDirective, selector: "[vdrDropdownTrigger]" }, { kind: "pipe", type: i3.AsyncPipe, name: "async" }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: UiExtensionPointComponent, decorators: [{
            type: Component,
            args: [{ selector: 'vdr-ui-extension-point', changeDetection: ChangeDetectionStrategy.OnPush, template: "<div [class.highlight]=\"isDevMode && (display$ | async)\" class=\"wrapper\" [style.display]=\"display\">\r\n    <vdr-dropdown *ngIf=\"isDevMode && (display$ | async)\" #dropdownComponent>\r\n        <button class=\"extension-point-info-trigger\"\r\n                [style.top.px]=\"topPx ?? 0\"\r\n                [style.left.px]=\"leftPx ?? 0\"\r\n                vdrDropdownTrigger>\r\n            <clr-icon shape=\"plugin\" class=\"\" size=\"12\"></clr-icon>\r\n        </button>\r\n        <vdr-dropdown-menu>\r\n            <div #editor contenteditable=\"false\" class=\"highlighted\"></div>\r\n        </vdr-dropdown-menu>\r\n    </vdr-dropdown>\r\n    <ng-content></ng-content>\r\n</div>\r\n", styles: [":host{position:relative}.wrapper{height:100%}button.extension-point-info-trigger{position:absolute;background-color:var(--color-accent-500);border-radius:50%;width:22px;height:22px;border:0;margin:0;padding:0;z-index:100;display:flex;align-items:center;justify-content:center;opacity:.8}button.extension-point-info-trigger:hover{opacity:1}button.extension-point-info-trigger clr-icon{color:#fff}.extension-info{padding:12px}pre{padding:6px;font-family:Source Code Pro,Lucida Console,Monaco,monospace;background-color:var(--color-grey-200)}::ng-deep .highlighted{margin:calc(var(--space-unit) * 2);padding:calc(var(--space-unit) * 2);border:1px solid var(--color-grey-300);border-radius:var(--border-radius);background-color:var(--color-component-bg-200);font-family:Source Code Pro,Lucida Console,Monaco,monospace;color:var(--color-json-editor-text)}::ng-deep .highlighted .ts-string{color:var(--color-accent-600)}::ng-deep .highlighted .ts-comment{color:var(--color-grey-500)}::ng-deep .highlighted .ts-keyword{color:var(--color-json-editor-key)}::ng-deep .highlighted .ts-default{color:var(--color-json-editor-text)}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.DataService }]; }, propDecorators: { locationId: [{
                type: Input
            }], metadata: [{
                type: Input
            }], topPx: [{
                type: Input
            }], leftPx: [{
                type: Input
            }], display: [{
                type: HostBinding,
                args: ['style.display']
            }, {
                type: Input
            }], api: [{
                type: Input
            }], editorElementRef: [{
                type: ViewChild,
                args: ['editor']
            }], dropdownComponent: [{
                type: ViewChild,
                args: ['dropdownComponent']
            }] } });
function highlightTsCode(tsCode) {
    tsCode = tsCode.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return tsCode.replace(/\b(abstract|any|as|boolean|break|case|catch|class|const|continue|default|do|else|enum|export|extends|false|finally|for|from|function|get|if|implements|import|in|instanceof|interface|is|keyof|let|module|namespace|never|new|null|number|object|of|private|protected|public|readonly|require|return|set|static|string|super|switch|symbol|this|throw|true|try|type|typeof|undefined|var|void|while|with|yield)\b|\/\/.*|\/\*[\s\S]*?\*\/|"(?:\\[\s\S]|[^\\"])*"|'[^']*'/g, (match, ...args) => {
        if (/^"/.test(match) || /^'/.test(match)) {
            return '<span class="ts-string">' + match + '</span>';
        }
        else if (/\/\/.*|\/\*[\s\S]*?\*\//.test(match)) {
            return '<span class="ts-comment">' + match + '</span>';
        }
        else if (/\b(abstract|any|as|boolean|break|case|catch|class|const|continue|default|do|else|enum|export|extends|false|finally|for|from|function|get|if|implements|import|in|instanceof|interface|is|keyof|let|module|namespace|never|new|null|number|object|of|private|protected|public|readonly|require|return|set|static|string|super|switch|symbol|this|throw|true|try|type|typeof|undefined|var|void|while|with|yield)\b/.test(match)) {
            return '<span class="ts-keyword">' + match + '</span>';
        }
        else {
            return '<span class="ts-default">' + match + '</span>';
        }
    });
}
const codeTemplates = {
    actionBar: locationId => `
import { addActionBarItem } from '@vendure/admin-ui/core';

export default [
  addActionBarItem({
    id: 'my-button',
    label: 'My Action',
    locationId: '${locationId}',
  });
]`,
    navMenu: locationId => `
import { addNavMenuSection } from '@vendure/admin-ui/core';

export default [
  addNavMenuSection({
      id: 'my-menu-item',
      label: 'My Menu Item',
      routerLink: ['/extensions/my-plugin'],
    }
    '${locationId}'
  );
]`,
    detailComponent: locationId => `
import { registerCustomDetailComponent } from '@vendure/admin-ui/core';

export default [
  registerCustomDetailComponent({
    locationId: '${locationId}',
    component: MyCustomComponent,
  });
]`,
    dataTable: (locationId, metadata) => `
import { registerDataTableComponent } from '@vendure/admin-ui/core';

export default [
  registerDataTableComponent({
    tableId: '${locationId}',
    columnId: '${metadata}',
    component: MyCustomComponent,
  });
]`,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWktZXh0ZW5zaW9uLXBvaW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvc2hhcmVkL2NvbXBvbmVudHMvdWktZXh0ZW5zaW9uLXBvaW50L3VpLWV4dGVuc2lvbi1wb2ludC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3NoYXJlZC9jb21wb25lbnRzL3VpLWV4dGVuc2lvbi1wb2ludC91aS1leHRlbnNpb24tcG9pbnQuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVILHVCQUF1QixFQUN2QixTQUFTLEVBRVQsV0FBVyxFQUNYLEtBQUssRUFDTCxTQUFTLEVBRVQsU0FBUyxHQUNaLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDbEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7OztBQWNyQyxNQUFNLE9BQU8seUJBQXlCO0lBZWxDLFlBQW9CLFdBQXdCO1FBQXhCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBUjVDLFlBQU8sR0FBNkIsY0FBYyxDQUFDO1FBTTFDLGNBQVMsR0FBRyxTQUFTLEVBQUUsQ0FBQztJQUVjLENBQUM7SUFFaEQsZUFBZSxDQUFDLEdBQW9CO1FBQ2hDLE9BQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3JFLENBQUM7SUFFRCxRQUFRO1FBQ0osSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU07YUFDbEMsT0FBTyxFQUFFO2FBQ1QsU0FBUyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsT0FBTyxD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QVUsQ0FBQyxFQUFFLENBQUM7Ozs7O21CQUtoQixVQUFVOzs7RUFHM0I7SUFDRSxTQUFTLEVBQUUsQ0FBQyxVQUFVLEVBQUUsUUFBUSxFQUFFLEVBQUUsQ0FBQzs7Ozs7Z0JBS3pCLFVBQVU7aUJBQ1QsUUFBUTs7O0VBR3ZCO0NBQ0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgICBBZnRlclZpZXdJbml0LFxyXG4gICAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXHJcbiAgICBDb21wb25lbnQsXHJcbiAgICBFbGVtZW50UmVmLFxyXG4gICAgSG9zdEJpbmRpbmcsXHJcbiAgICBJbnB1dCxcclxuICAgIGlzRGV2TW9kZSxcclxuICAgIE9uSW5pdCxcclxuICAgIFZpZXdDaGlsZCxcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBDb2RlSmFyIH0gZnJvbSAnY29kZWphcic7XHJcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IFVJRXh0ZW5zaW9uTG9jYXRpb25JZCB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9jb21wb25lbnQtcmVnaXN0cnktdHlwZXMnO1xyXG5pbXBvcnQgeyBEYXRhU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL2RhdGEvcHJvdmlkZXJzL2RhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IERyb3Bkb3duQ29tcG9uZW50IH0gZnJvbSAnLi4vZHJvcGRvd24vZHJvcGRvd24uY29tcG9uZW50JztcclxuXHJcbnR5cGUgVWlFeHRlbnNpb25UeXBlID0gJ2FjdGlvbkJhcicgfCAnbmF2TWVudScgfCAnZGV0YWlsQ29tcG9uZW50JyB8ICdkYXRhVGFibGUnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3Zkci11aS1leHRlbnNpb24tcG9pbnQnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL3VpLWV4dGVuc2lvbi1wb2ludC5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi91aS1leHRlbnNpb24tcG9pbnQuY29tcG9uZW50LnNjc3MnXSxcclxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgVWlFeHRlbnNpb25Qb2ludENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XHJcbiAgICBASW5wdXQoKSBsb2NhdGlvbklkOiBVSUV4dGVuc2lvbkxvY2F0aW9uSWQ7XHJcbiAgICBASW5wdXQoKSBtZXRhZGF0YT86IGFueTtcclxuICAgIEBJbnB1dCgpIHRvcFB4OiBudW1iZXI7XHJcbiAgICBASW5wdXQoKSBsZWZ0UHg6IG51bWJlcjtcclxuICAgIEBIb3N0QmluZGluZygnc3R5bGUuZGlzcGxheScpXHJcbiAgICBASW5wdXQoKVxyXG4gICAgZGlzcGxheTogJ2Jsb2NrJyB8ICdpbmxpbmUtYmxvY2snID0gJ2lubGluZS1ibG9jayc7XHJcbiAgICBASW5wdXQoKSBhcGk6IFVpRXh0ZW5zaW9uVHlwZTtcclxuICAgIEBWaWV3Q2hpbGQoJ2VkaXRvcicpIHByaXZhdGUgZWRpdG9yRWxlbWVudFJlZjogRWxlbWVudFJlZjxIVE1MRGl2RWxlbWVudD47XHJcbiAgICBAVmlld0NoaWxkKCdkcm9wZG93bkNvbXBvbmVudCcpIHByaXZhdGUgZHJvcGRvd25Db21wb25lbnQ6IERyb3Bkb3duQ29tcG9uZW50O1xyXG4gICAgZGlzcGxheSQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XHJcbiAgICBqYXI6IENvZGVKYXI7XHJcbiAgICByZWFkb25seSBpc0Rldk1vZGUgPSBpc0Rldk1vZGUoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSkge31cclxuXHJcbiAgICBnZXRDb2RlVGVtcGxhdGUoYXBpOiBVaUV4dGVuc2lvblR5cGUpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBjb2RlVGVtcGxhdGVzW2FwaV0odGhpcy5sb2NhdGlvbklkLCB0aGlzLm1ldGFkYXRhKS50cmltKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5kaXNwbGF5JCA9IHRoaXMuZGF0YVNlcnZpY2UuY2xpZW50XHJcbiAgICAgICAgICAgIC51aVN0YXRlKClcclxuICAgICAgICAgICAgLm1hcFN0cmVhbSgoeyB1aVN0YXRlIH0pID0+IHVpU3RhdGUuZGlzcGxheVVpRXh0ZW5zaW9uUG9pbnRzKVxyXG4gICAgICAgICAgICAucGlwZShcclxuICAgICAgICAgICAgICAgIHRhcChkaXNwbGF5ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGlzcGxheSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhpZ2hsaWdodCA9IChlZGl0b3I6IEhUTUxFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29kZSA9IGVkaXRvci50ZXh0Q29udGVudCA/PyAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IuaW5uZXJIVE1MID0gaGlnaGxpZ2h0VHNDb2RlKHRoaXMuZ2V0Q29kZVRlbXBsYXRlKHRoaXMuYXBpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3JFbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY29udGVudEVkaXRhYmxlID0gJ2ZhbHNlJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuamFyID0gQ29kZUphcih0aGlzLmVkaXRvckVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgaGlnaGxpZ2h0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuamFyLnVwZGF0ZUNvZGUodGhpcy5nZXRDb2RlVGVtcGxhdGUodGhpcy5hcGkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIC8vIHRoaXMuZHJvcGRvd25Db21wb25lbnQub25PcGVuQ2hhbmdlKGlzT3BlbiA9PiB7XHJcbiAgICAgICAgLy8gICAgIGlmIChpc09wZW4pIHtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoaWdobGlnaHRUc0NvZGUodHNDb2RlOiBzdHJpbmcpIHtcclxuICAgIHRzQ29kZSA9IHRzQ29kZS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7Jyk7XHJcblxyXG4gICAgcmV0dXJuIHRzQ29kZS5yZXBsYWNlKFxyXG4gICAgICAgIC9cXGIoYWJzdHJhY3R8YW55fGFzfGJvb2xlYW58YnJlYWt8Y2FzZXxjYXRjaHxjbGFzc3xjb25zdHxjb250aW51ZXxkZWZhdWx0fGRvfGVsc2V8ZW51bXxleHBvcnR8ZXh0ZW5kc3xmYWxzZXxmaW5hbGx5fGZvcnxmcm9tfGZ1bmN0aW9ufGdldHxpZnxpbXBsZW1lbnRzfGltcG9ydHxpbnxpbnN0YW5jZW9mfGludGVyZmFjZXxpc3xrZXlvZnxsZXR8bW9kdWxlfG5hbWVzcGFjZXxuZXZlcnxuZXd8bnVsbHxudW1iZXJ8b2JqZWN0fG9mfHByaXZhdGV8cHJvdGVjdGVkfHB1YmxpY3xyZWFkb25seXxyZXF1aXJlfHJldHVybnxzZXR8c3RhdGljfHN0cmluZ3xzdXBlcnxzd2l0Y2h8c3ltYm9sfHRoaXN8dGhyb3d8dHJ1ZXx0cnl8dHlwZXx0eXBlb2Z8dW5kZWZpbmVkfHZhcnx2b2lkfHdoaWxlfHdpdGh8eWllbGQpXFxifFxcL1xcLy4qfFxcL1xcKltcXHNcXFNdKj9cXCpcXC98XCIoPzpcXFxcW1xcc1xcU118W15cXFxcXCJdKSpcInwnW14nXSonL2csXHJcbiAgICAgICAgKG1hdGNoLCAuLi5hcmdzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICgvXlwiLy50ZXN0KG1hdGNoKSB8fCAvXicvLnRlc3QobWF0Y2gpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwidHMtc3RyaW5nXCI+JyArIG1hdGNoICsgJzwvc3Bhbj4nO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKC9cXC9cXC8uKnxcXC9cXCpbXFxzXFxTXSo/XFwqXFwvLy50ZXN0KG1hdGNoKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cInRzLWNvbW1lbnRcIj4nICsgbWF0Y2ggKyAnPC9zcGFuPic7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXHJcbiAgICAgICAgICAgICAgICAvXFxiKGFic3RyYWN0fGFueXxhc3xib29sZWFufGJyZWFrfGNhc2V8Y2F0Y2h8Y2xhc3N8Y29uc3R8Y29udGludWV8ZGVmYXVsdHxkb3xlbHNlfGVudW18ZXhwb3J0fGV4dGVuZHN8ZmFsc2V8ZmluYWxseXxmb3J8ZnJvbXxmdW5jdGlvbnxnZXR8aWZ8aW1wbGVtZW50c3xpbXBvcnR8aW58aW5zdGFuY2VvZnxpbnRlcmZhY2V8aXN8a2V5b2Z8bGV0fG1vZHVsZXxuYW1lc3BhY2V8bmV2ZXJ8bmV3fG51bGx8bnVtYmVyfG9iamVjdHxvZnxwcml2YXRlfHByb3RlY3RlZHxwdWJsaWN8cmVhZG9ubHl8cmVxdWlyZXxyZXR1cm58c2V0fHN0YXRpY3xzdHJpbmd8c3VwZXJ8c3dpdGNofHN5bWJvbHx0aGlzfHRocm93fHRydWV8dHJ5fHR5cGV8dHlwZW9mfHVuZGVmaW5lZHx2YXJ8dm9pZHx3aGlsZXx3aXRofHlpZWxkKVxcYi8udGVzdChcclxuICAgICAgICAgICAgICAgICAgICBtYXRjaCxcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwidHMta2V5d29yZFwiPicgKyBtYXRjaCArICc8L3NwYW4+JztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJ0cy1kZWZhdWx0XCI+JyArIG1hdGNoICsgJzwvc3Bhbj4nO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICk7XHJcbn1cclxuXHJcbmNvbnN0IGNvZGVUZW1wbGF0ZXM6IFJlY29yZDxVaUV4dGVuc2lvblR5cGUsIChsb2NhdGlvbklkOiBVSUV4dGVuc2lvbkxvY2F0aW9uSWQsIG1ldGFkYXRhOiBhbnkpID0+IHN0cmluZz4gPSB7XHJcbiAgICBhY3Rpb25CYXI6IGxvY2F0aW9uSWQgPT4gYFxyXG5pbXBvcnQgeyBhZGRBY3Rpb25CYXJJdGVtIH0gZnJvbSAnQHZlbmR1cmUvYWRtaW4tdWkvY29yZSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBbXHJcbiAgYWRkQWN0aW9uQmFySXRlbSh7XHJcbiAgICBpZDogJ215LWJ1dHRvbicsXHJcbiAgICBsYWJlbDogJ015IEFjdGlvbicsXHJcbiAgICBsb2NhdGlvbklkOiAnJHtsb2NhdGlvbklkfScsXHJcbiAgfSk7XHJcbl1gLFxyXG4gICAgbmF2TWVudTogbG9jYXRpb25JZCA9PiBgXHJcbmltcG9ydCB7IGFkZE5hdk1lbnVTZWN0aW9uIH0gZnJvbSAnQHZlbmR1cmUvYWRtaW4tdWkvY29yZSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBbXHJcbiAgYWRkTmF2TWVudVNlY3Rpb24oe1xyXG4gICAgICBpZDogJ215LW1lbnUtaXRlbScsXHJcbiAgICAgIGxhYmVsOiAnTXkgTWVudSBJdGVtJyxcclxuICAgICAgcm91dGVyTGluazogWycvZXh0ZW5zaW9ucy9teS1wbHVnaW4nXSxcclxuICAgIH1cclxuICAgICcke2xvY2F0aW9uSWR9J1xyXG4gICk7XHJcbl1gLFxyXG4gICAgZGV0YWlsQ29tcG9uZW50OiBsb2NhdGlvbklkID0+IGBcclxuaW1wb3J0IHsgcmVnaXN0ZXJDdXN0b21EZXRhaWxDb21wb25lbnQgfSBmcm9tICdAdmVuZHVyZS9hZG1pbi11aS9jb3JlJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFtcclxuICByZWdpc3RlckN1c3RvbURldGFpbENvbXBvbmVudCh7XHJcbiAgICBsb2NhdGlvbklkOiAnJHtsb2NhdGlvbklkfScsXHJcbiAgICBjb21wb25lbnQ6IE15Q3VzdG9tQ29tcG9uZW50LFxyXG4gIH0pO1xyXG5dYCxcclxuICAgIGRhdGFUYWJsZTogKGxvY2F0aW9uSWQsIG1ldGFkYXRhKSA9PiBgXHJcbmltcG9ydCB7IHJlZ2lzdGVyRGF0YVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnQHZlbmR1cmUvYWRtaW4tdWkvY29yZSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBbXHJcbiAgcmVnaXN0ZXJEYXRhVGFibGVDb21wb25lbnQoe1xyXG4gICAgdGFibGVJZDogJyR7bG9jYXRpb25JZH0nLFxyXG4gICAgY29sdW1uSWQ6ICcke21ldGFkYXRhfScsXHJcbiAgICBjb21wb25lbnQ6IE15Q3VzdG9tQ29tcG9uZW50LFxyXG4gIH0pO1xyXG5dYCxcclxufTtcclxuIiwiPGRpdiBbY2xhc3MuaGlnaGxpZ2h0XT1cImlzRGV2TW9kZSAmJiAoZGlzcGxheSQgfCBhc3luYylcIiBjbGFzcz1cIndyYXBwZXJcIiBbc3R5bGUuZGlzcGxheV09XCJkaXNwbGF5XCI+XHJcbiAgICA8dmRyLWRyb3Bkb3duICpuZ0lmPVwiaXNEZXZNb2RlICYmIChkaXNwbGF5JCB8IGFzeW5jKVwiICNkcm9wZG93bkNvbXBvbmVudD5cclxuICAgICAgICA8YnV0dG9uIGNsYXNzPVwiZXh0ZW5zaW9uLXBvaW50LWluZm8tdHJpZ2dlclwiXHJcbiAgICAgICAgICAgICAgICBbc3R5bGUudG9wLnB4XT1cInRvcFB4ID8/IDBcIlxyXG4gICAgICAgICAgICAgICAgW3N0eWxlLmxlZnQucHhdPVwibGVmdFB4ID8/IDBcIlxyXG4gICAgICAgICAgICAgICAgdmRyRHJvcGRvd25UcmlnZ2VyPlxyXG4gICAgICAgICAgICA8Y2xyLWljb24gc2hhcGU9XCJwbHVnaW5cIiBjbGFzcz1cIlwiIHNpemU9XCIxMlwiPjwvY2xyLWljb24+XHJcbiAgICAgICAgPC9idXR0b24+XHJcbiAgICAgICAgPHZkci1kcm9wZG93bi1tZW51PlxyXG4gICAgICAgICAgICA8ZGl2ICNlZGl0b3IgY29udGVudGVkaXRhYmxlPVwiZmFsc2VcIiBjbGFzcz1cImhpZ2hsaWdodGVkXCI+PC9kaXY+XHJcbiAgICAgICAgPC92ZHItZHJvcGRvd24tbWVudT5cclxuICAgIDwvdmRyLWRyb3Bkb3duPlxyXG4gICAgPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PlxyXG48L2Rpdj5cclxuIl19