import { assertNever } from '@vendure/common/lib/shared-utils';
import dayjs from 'dayjs';
export class DataTableFilter {
    constructor(options, onActivate) {
        this.options = options;
        this.onActivate = onActivate;
    }
    get name() {
        return this.options.name;
    }
    get type() {
        return this.options.type;
    }
    get label() {
        return this.options.label;
    }
    getFilterOperator(value) {
        const type = this.options.type;
        switch (type.kind) {
            case 'boolean':
                return {
                    eq: !!value,
                };
            case 'dateRange': {
                let dateOperators;
                const mode = value.mode ?? 'relative';
                if (mode === 'relative') {
                    const relativeValue = value.relativeValue ?? 30;
                    const relativeUnit = value.relativeUnit ?? 'day';
                    dateOperators = {
                        after: dayjs().subtract(relativeValue, relativeUnit).startOf('day').toISOString(),
                    };
                }
                else {
                    const start = value.start ?? undefined;
                    const end = value.end ?? undefined;
                    if (start && end) {
                        dateOperators = {
                            between: { start, end },
                        };
                    }
                    else if (start) {
                        dateOperators = {
                            after: start,
                        };
                    }
                    else {
                        dateOperators = {
                            before: end,
                        };
                    }
                }
                return dateOperators;
            }
            case 'number':
                return {
                    [value.operator]: Number(value.amount),
                };
            case 'select':
                return { in: value };
            case 'text':
                return {
                    [value.operator]: value.term,
                };
            case 'id':
                return {
                    [value.operator]: value.term,
                };
            case 'custom': {
                return value;
            }
            default:
                assertNever(type);
        }
    }
    toFilterInput(value) {
        if (this.options.toFilterInput) {
            return this.options.toFilterInput(value);
        }
        if (this.options.filterField) {
            return { [this.options.filterField]: this.getFilterOperator(value) };
        }
        else {
            throw new Error(`Either "filterField" or "toFilterInput" must be provided (for filter "${this.name}"))`);
        }
    }
    activate(value) {
        if (this.onActivate) {
            this.onActivate(this, value);
        }
    }
    isId() {
        return this.type.kind === 'id';
    }
    isText() {
        return this.type.kind === 'text';
    }
    isNumber() {
        return this.type.kind === 'number';
    }
    isBoolean() {
        return this.type.kind === 'boolean';
    }
    isSelect() {
        return this.type.kind === 'select';
    }
    isDateRange() {
        return this.type.kind === 'dateRange';
    }
    isCustom() {
        return this.type.kind === 'custom';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS10YWJsZS1maWx0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3Byb3ZpZGVycy9kYXRhLXRhYmxlL2RhdGEtdGFibGUtZmlsdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUMvRCxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFrRzFCLE1BQU0sT0FBTyxlQUFlO0lBSXhCLFlBQ3FCLE9BQWtELEVBQzNELFVBR0M7UUFKUSxZQUFPLEdBQVAsT0FBTyxDQUEyQztRQUMzRCxlQUFVLEdBQVYsVUFBVSxDQUdUO0lBQ1YsQ0FBQztJQUVKLElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksS0FBSztRQUNMLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUVELGlCQUFpQixDQUFDLEtBQVU7UUFDeEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDL0IsUUFBUSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ2YsS0FBSyxTQUFTO2dCQUNWLE9BQU87b0JBQ0gsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLO2lCQUNkLENBQUM7WUFDTixLQUFLLFdBQVcsQ0FBQyxDQUFDO2dCQUNkLElBQUksYUFBNEIsQ0FBQztnQkFDakMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksSUFBSSxVQUFVLENBQUM7Z0JBQ3RDLElBQUksSUFBSSxLQUFLLFVBQVUsRUFBRTtvQkFDckIsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLGFBQWEsSUFBSSxF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QUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxRQUFRLENBQUM7SUFDdkMsQ0FBQztJQUVELFdBQVc7UUFDUCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQztJQUMxQyxDQUFDO0lBRUQsUUFBUTtRQUNKLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDO0lBQ3ZDLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR5cGUgYXMgQ29tcG9uZW50VHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBMb2NhbGl6ZWRTdHJpbmcgfSBmcm9tICdAdmVuZHVyZS9jb21tb24vbGliL2dlbmVyYXRlZC10eXBlcyc7XHJcbmltcG9ydCB7IGFzc2VydE5ldmVyIH0gZnJvbSAnQHZlbmR1cmUvY29tbW9uL2xpYi9zaGFyZWQtdXRpbHMnO1xyXG5pbXBvcnQgZGF5anMgZnJvbSAnZGF5anMnO1xyXG5pbXBvcnQgeyBGb3JtSW5wdXRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9jb21tb24vY29tcG9uZW50LXJlZ2lzdHJ5LXR5cGVzJztcclxuaW1wb3J0IHtcclxuICAgIEJvb2xlYW5PcGVyYXRvcnMsXHJcbiAgICBEYXRlT3BlcmF0b3JzLFxyXG4gICAgSWRPcGVyYXRvcnMsXHJcbiAgICBOdW1iZXJPcGVyYXRvcnMsXHJcbiAgICBTdHJpbmdPcGVyYXRvcnMsXHJcbn0gZnJvbSAnLi4vLi4vY29tbW9uL2dlbmVyYXRlZC10eXBlcyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFUYWJsZUZpbHRlcklEVHlwZSB7XHJcbiAgICBraW5kOiAnaWQnO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFUYWJsZUZpbHRlclRleHRUeXBlIHtcclxuICAgIGtpbmQ6ICd0ZXh0JztcclxuICAgIHBsYWNlaG9sZGVyPzogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFUYWJsZUZpbHRlclNlbGVjdFR5cGUge1xyXG4gICAga2luZDogJ3NlbGVjdCc7XHJcbiAgICBvcHRpb25zOiBBcnJheTx7IHZhbHVlOiBhbnk7IGxhYmVsOiBzdHJpbmcgfT47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGF0YVRhYmxlRmlsdGVyQm9vbGVhblR5cGUge1xyXG4gICAga2luZDogJ2Jvb2xlYW4nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFUYWJsZUZpbHRlck51bWJlclR5cGUge1xyXG4gICAga2luZDogJ251bWJlcic7XHJcbiAgICBpbnB1dFR5cGU/OiAnbnVtYmVyJyB8ICdjdXJyZW5jeSc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGF0YVRhYmxlRmlsdGVyRGF0ZVJhbmdlVHlwZSB7XHJcbiAgICBraW5kOiAnZGF0ZVJhbmdlJztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEYXRhVGFibGVGaWx0ZXJDdXN0b21UeXBlIHtcclxuICAgIGtpbmQ6ICdjdXN0b20nO1xyXG4gICAgY29tcG9uZW50OiBDb21wb25lbnRUeXBlPEZvcm1JbnB1dENvbXBvbmVudD47XHJcbiAgICBzZXJpYWxpemVWYWx1ZTogKHZhbHVlOiBhbnkpID0+IHN0cmluZztcclxuICAgIGRlc2VyaWFsaXplVmFsdWU6IChzZXJpYWxpemVkOiBzdHJpbmcpID0+IGFueTtcclxuICAgIGdldExhYmVsKHZhbHVlOiBhbnkpOiBzdHJpbmcgfCBQcm9taXNlPHN0cmluZz47XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEtpbmRWYWx1ZU1hcCA9IHtcclxuICAgIGlkOiB7XHJcbiAgICAgICAgcmF3OiB7XHJcbiAgICAgICAgICAgIG9wZXJhdG9yOiBrZXlvZiBJZE9wZXJhdG9ycztcclxuICAgICAgICAgICAgdGVybTogc3RyaW5nO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgaW5wdXQ6IElkT3BlcmF0b3JzO1xyXG4gICAgfTtcclxuICAgIHRleHQ6IHtcclxuICAgICAgICByYXc6IHtcclxuICAgICAgICAgICAgb3BlcmF0b3I6IGtleW9mIFN0cmluZ09wZXJhdG9ycztcclxuICAgICAgICAgICAgdGVybTogc3RyaW5nO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgaW5wdXQ6IFN0cmluZ09wZXJhdG9ycztcclxuICAgIH07XHJcbiAgICBzZWxlY3Q6IHsgcmF3OiBzdHJpbmdbXTsgaW5wdXQ6IFN0cmluZ09wZXJhdG9ycyB9O1xyXG4gICAgYm9vbGVhbjogeyByYXc6IGJvb2xlYW47IGlucHV0OiBCb29sZWFuT3BlcmF0b3JzIH07XHJcbiAgICBkYXRlUmFuZ2U6IHtcclxuICAgICAgICByYXc6IHtcclxuICAgICAgICAgICAgbW9kZTogJ3JlbGF0aXZlJyB8ICdyYW5nZSc7XHJcbiAgICAgICAgICAgIHJlbGF0aXZlVmFsdWU6IG51bWJlcjtcclxuICAgICAgICAgICAgcmVsYXRpdmVVbml0OiAnZGF5JyB8ICdtb250aCcgfCAneWVhcic7XHJcbiAgICAgICAgICAgIHN0YXJ0Pzogc3RyaW5nO1xyXG4gICAgICAgICAgICBlbmQ/OiBzdHJpbmc7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBpbnB1dDogRGF0ZU9wZXJhdG9ycztcclxuICAgIH07XHJcbiAgICBudW1iZXI6IHsgcmF3OiB7IG9wZXJhdG9yOiBrZXlvZiBOdW1iZXJPcGVyYXRvcnM7IGFtb3VudDogbnVtYmVyIH07IGlucHV0OiBOdW1iZXJPcGVyYXRvcnMgfTtcclxuICAgIGN1c3RvbTogeyByYXc6IGFueTsgaW5wdXQ6IGFueSB9O1xyXG59O1xyXG5leHBvcnQgdHlwZSBEYXRhVGFibGVGaWx0ZXJUeXBlID1cclxuICAgIHwgRGF0YVRhYmxlRmlsdGVySURUeXBlXHJcbiAgICB8IERhdGFUYWJsZUZpbHRlclRleHRUeXBlXHJcbiAgICB8IERhdGFUYWJsZUZpbHRlclNlbGVjdFR5cGVcclxuICAgIHwgRGF0YVRhYmxlRmlsdGVyQm9vbGVhblR5cGVcclxuICAgIHwgRGF0YVRhYmxlRmlsdGVyRGF0ZVJhbmdlVHlwZVxyXG4gICAgfCBEYXRhVGFibGVGaWx0ZXJOdW1iZXJUeXBlXHJcbiAgICB8IERhdGFUYWJsZUZpbHRlckN1c3RvbVR5cGU7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFUYWJsZUZpbHRlck9wdGlvbnM8XHJcbiAgICBGaWx0ZXJJbnB1dCBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4gPSBhbnksXHJcbiAgICBUeXBlIGV4dGVuZHMgRGF0YVRhYmxlRmlsdGVyVHlwZSA9IERhdGFUYWJsZUZpbHRlclR5cGUsXHJcbj4ge1xyXG4gICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgdHlwZTogVHlwZTtcclxuICAgIHJlYWRvbmx5IGxhYmVsOiBzdHJpbmcgfCBMb2NhbGl6ZWRTdHJpbmdbXTtcclxuICAgIHJlYWRvbmx5IGZpbHRlckZpZWxkPzoga2V5b2YgRmlsdGVySW5wdXQ7XHJcbiAgICByZWFkb25seSB0b0ZpbHRlcklucHV0PzogKHZhbHVlOiBEYXRhVGFibGVGaWx0ZXJWYWx1ZTxUeXBlPikgPT4gUGFydGlhbDxGaWx0ZXJJbnB1dD47XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIERhdGFUYWJsZUZpbHRlclZhbHVlPFR5cGUgZXh0ZW5kcyBEYXRhVGFibGVGaWx0ZXJUeXBlPiA9IEtpbmRWYWx1ZU1hcFtUeXBlWydraW5kJ11dWydyYXcnXTtcclxuZXhwb3J0IHR5cGUgRGF0YVRhYmxlRmlsdGVyT3BlcmF0b3I8VHlwZSBleHRlbmRzIERhdGFUYWJsZUZpbHRlclR5cGU+ID0gS2luZFZhbHVlTWFwW1R5cGVbJ2tpbmQnXV1bJ2lucHV0J107XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YVRhYmxlRmlsdGVyPFxyXG4gICAgRmlsdGVySW5wdXQgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0gYW55LFxyXG4gICAgVHlwZSBleHRlbmRzIERhdGFUYWJsZUZpbHRlclR5cGUgPSBEYXRhVGFibGVGaWx0ZXJUeXBlLFxyXG4+IHtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uczogRGF0YVRhYmxlRmlsdGVyT3B0aW9uczxGaWx0ZXJJbnB1dCwgVHlwZT4sXHJcbiAgICAgICAgcHJpdmF0ZSBvbkFjdGl2YXRlPzogKFxyXG4gICAgICAgICAgICBmaWx0ZXI6IERhdGFUYWJsZUZpbHRlcjxGaWx0ZXJJbnB1dCwgVHlwZT4sXHJcbiAgICAgICAgICAgIHZhbHVlOiBEYXRhVGFibGVGaWx0ZXJWYWx1ZTxUeXBlPiB8IHVuZGVmaW5lZCxcclxuICAgICAgICApID0+IHZvaWQsXHJcbiAgICApIHt9XHJcblxyXG4gICAgZ2V0IG5hbWUoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLm5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHR5cGUoKTogVHlwZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy50eXBlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBsYWJlbCgpOiBzdHJpbmcgfCBMb2NhbGl6ZWRTdHJpbmdbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5sYWJlbDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRGaWx0ZXJPcGVyYXRvcih2YWx1ZTogYW55KTogRGF0YVRhYmxlRmlsdGVyT3BlcmF0b3I8VHlwZT4ge1xyXG4gICAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLm9wdGlvbnMudHlwZTtcclxuICAgICAgICBzd2l0Y2ggKHR5cGUua2luZCkge1xyXG4gICAgICAgICAgICBjYXNlICdib29sZWFuJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXE6ICEhdmFsdWUsXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYXNlICdkYXRlUmFuZ2UnOiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGF0ZU9wZXJhdG9yczogRGF0ZU9wZXJhdG9ycztcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vZGUgPSB2YWx1ZS5tb2RlID8/ICdyZWxhdGl2ZSc7XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZSA9PT0gJ3JlbGF0aXZlJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlVmFsdWUgPSB2YWx1ZS5yZWxhdGl2ZVZhbHVlID8/IDMwO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlVW5pdCA9IHZhbHVlLnJlbGF0aXZlVW5pdCA/PyAnZGF5JztcclxuICAgICAgICAgICAgICAgICAgICBkYXRlT3BlcmF0b3JzID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhZnRlcjogZGF5anMoKS5zdWJ0cmFjdChyZWxhdGl2ZVZhbHVlLCByZWxhdGl2ZVVuaXQpLnN0YXJ0T2YoJ2RheScpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSB2YWx1ZS5zdGFydCA/PyB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gdmFsdWUuZW5kID8/IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnQgJiYgZW5kKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVPcGVyYXRvcnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZXR3ZWVuOiB7IHN0YXJ0LCBlbmQgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVPcGVyYXRvcnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlcjogc3RhcnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZU9wZXJhdG9ycyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZTogZW5kLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRlT3BlcmF0b3JzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIFt2YWx1ZS5vcGVyYXRvcl06IE51bWJlcih2YWx1ZS5hbW91bnQpLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBpbjogdmFsdWUgfTtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIFt2YWx1ZS5vcGVyYXRvcl06IHZhbHVlLnRlcm0sXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYXNlICdpZCc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIFt2YWx1ZS5vcGVyYXRvcl06IHZhbHVlLnRlcm0sXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYXNlICdjdXN0b20nOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGFzc2VydE5ldmVyKHR5cGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0b0ZpbHRlcklucHV0KHZhbHVlOiBEYXRhVGFibGVGaWx0ZXJWYWx1ZTxUeXBlPik6IFBhcnRpYWw8RmlsdGVySW5wdXQ+IHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRvRmlsdGVySW5wdXQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy50b0ZpbHRlcklucHV0KHZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5maWx0ZXJGaWVsZCkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBbdGhpcy5vcHRpb25zLmZpbHRlckZpZWxkXTogdGhpcy5nZXRGaWx0ZXJPcGVyYXRvcih2YWx1ZSkgfSBhcyBQYXJ0aWFsPEZpbHRlcklucHV0PjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgICAgICAgICBgRWl0aGVyIFwiZmlsdGVyRmllbGRcIiBvciBcInRvRmlsdGVySW5wdXRcIiBtdXN0IGJlIHByb3ZpZGVkIChmb3IgZmlsdGVyIFwiJHt0aGlzLm5hbWV9XCIpKWAsXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFjdGl2YXRlKHZhbHVlOiBEYXRhVGFibGVGaWx0ZXJWYWx1ZTxUeXBlPikge1xyXG4gICAgICAgIGlmICh0aGlzLm9uQWN0aXZhdGUpIHtcclxuICAgICAgICAgICAgdGhpcy5vbkFjdGl2YXRlKHRoaXMsIHZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaXNJZCgpOiB0aGlzIGlzIERhdGFUYWJsZUZpbHRlcjxGaWx0ZXJJbnB1dCwgRGF0YVRhYmxlRmlsdGVySURUeXBlPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHlwZS5raW5kID09PSAnaWQnO1xyXG4gICAgfVxyXG5cclxuICAgIGlzVGV4dCgpOiB0aGlzIGlzIERhdGFUYWJsZUZpbHRlcjxGaWx0ZXJJbnB1dCwgRGF0YVRhYmxlRmlsdGVyVGV4dFR5cGU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy50eXBlLmtpbmQgPT09ICd0ZXh0JztcclxuICAgIH1cclxuXHJcbiAgICBpc051bWJlcigpOiB0aGlzIGlzIERhdGFUYWJsZUZpbHRlcjxGaWx0ZXJJbnB1dCwgRGF0YVRhYmxlRmlsdGVyTnVtYmVyVHlwZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnR5cGUua2luZCA9PT0gJ251bWJlcic7XHJcbiAgICB9XHJcblxyXG4gICAgaXNCb29sZWFuKCk6IHRoaXMgaXMgRGF0YVRhYmxlRmlsdGVyPEZpbHRlcklucHV0LCBEYXRhVGFibGVGaWx0ZXJCb29sZWFuVHlwZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnR5cGUua2luZCA9PT0gJ2Jvb2xlYW4nO1xyXG4gICAgfVxyXG5cclxuICAgIGlzU2VsZWN0KCk6IHRoaXMgaXMgRGF0YVRhYmxlRmlsdGVyPEZpbHRlcklucHV0LCBEYXRhVGFibGVGaWx0ZXJTZWxlY3RUeXBlPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHlwZS5raW5kID09PSAnc2VsZWN0JztcclxuICAgIH1cclxuXHJcbiAgICBpc0RhdGVSYW5nZSgpOiB0aGlzIGlzIERhdGFUYWJsZUZpbHRlcjxGaWx0ZXJJbnB1dCwgRGF0YVRhYmxlRmlsdGVyRGF0ZVJhbmdlVHlwZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnR5cGUua2luZCA9PT0gJ2RhdGVSYW5nZSc7XHJcbiAgICB9XHJcblxyXG4gICAgaXNDdXN0b20oKTogdGhpcyBpcyBEYXRhVGFibGVGaWx0ZXI8RmlsdGVySW5wdXQsIERhdGFUYWJsZUZpbHRlckN1c3RvbVR5cGU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy50eXBlLmtpbmQgPT09ICdjdXN0b20nO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==