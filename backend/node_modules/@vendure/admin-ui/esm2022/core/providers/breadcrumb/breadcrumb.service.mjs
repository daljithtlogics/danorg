import { Injectable } from '@angular/core';
import { NavigationEnd, PRIMARY_OUTLET } from '@angular/router';
import { flatten } from 'lodash';
import { combineLatest as observableCombineLatest, isObservable, of as observableOf, Subject, } from 'rxjs';
import { filter, map, shareReplay, startWith, switchMap, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "../../data/providers/data.service";
export class BreadcrumbService {
    constructor(router, route, dataService) {
        this.router = router;
        this.route = route;
        this.dataService = dataService;
        this.destroy$ = new Subject();
        this.breadcrumbs$ = this.router.events.pipe(filter(event => event instanceof NavigationEnd), takeUntil(this.destroy$), startWith(true), switchMap(() => this.generateBreadcrumbs(this.route.root)), shareReplay(1));
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    generateBreadcrumbs(rootRoute) {
        const breadcrumbParts = this.assembleBreadcrumbParts(rootRoute);
        const breadcrumbObservables$ = breadcrumbParts.map(({ value$, path }) => value$.pipe(map(value => {
            if (isBreadcrumbLabelLinkPair(value)) {
                return {
                    label: value.label,
                    link: this.normalizeRelativeLinks(value.link, path),
                };
            }
            else if (isBreadcrumbPairArray(value)) {
                return value.map(val => ({
                    label: val.label,
                    link: this.normalizeRelativeLinks(val.link, path),
                }));
            }
            else {
                return {
                    label: value,
                    link: '/' + path.join('/'),
                };
            }
        })));
        return observableCombineLatest(breadcrumbObservables$).pipe(map(links => flatten(links)));
    }
    /**
     * Walks the route definition tree to assemble an array from which the breadcrumbs can be derived.
     */
    assembleBreadcrumbParts(rootRoute) {
        const breadcrumbParts = [];
        const segmentPaths = [];
        let currentRoute = rootRoute;
        do {
            const childRoutes = currentRoute.children;
            currentRoute = null;
            childRoutes.forEach((route) => {
                if (route.outlet === PRIMARY_OUTLET) {
                    const routeSnapshot = route.snapshot;
                    let breadcrumbDef = route.routeConfig && route.routeConfig.data && route.routeConfig.data['breadcrumb'];
                    segmentPaths.push(routeSnapshot.url.map(segment => segment.path).join('/'));
                    if (breadcrumbDef) {
                        if (isBreadcrumbFunction(breadcrumbDef)) {
                            breadcrumbDef = breadcrumbDef(routeSnapshot.data, routeSnapshot.params, this.dataService);
                        }
                        const observableValue = isObservable(breadcrumbDef)
                            ? breadcrumbDef
                            : observableOf(breadcrumbDef);
                        breadcrumbParts.push({ value$: observableValue, path: segmentPaths.slice() });
                    }
                    currentRoute = route;
                }
            });
        } while (currentRoute);
        return breadcrumbParts;
    }
    /**
     * Accounts for relative routes in the link array, i.e. arrays whose first element is either:
     * * `./`   - this appends the rest of the link segments to the current active route
     * * `../`  - this removes the last segment of the current active route, and appends the link segments
     *            to the parent route.
     */
    normalizeRelativeLinks(link, segmentPaths) {
        const clone = link.slice();
        if (clone[0] === './') {
            clone[0] = segmentPaths.join('/');
        }
        if (clone[0] === '../') {
            clone[0] = segmentPaths.slice(0, -1).join('/');
        }
        return clone.filter(segment => segment !== '');
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: BreadcrumbService, deps: [{ token: i1.Router }, { token: i1.ActivatedRoute }, { token: i2.DataService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: BreadcrumbService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: BreadcrumbService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.Router }, { type: i1.ActivatedRoute }, { type: i2.DataService }]; } });
function isBreadcrumbFunction(value) {
    return typeof value === 'function';
}
function isBreadcrumbLabelLinkPair(value) {
    return value.hasOwnProperty('label') && value.hasOwnProperty('link');
}
function isBreadcrumbPairArray(value) {
    return Array.isArray(value) && isBreadcrumbLabelLinkPair(value[0]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJlYWRjcnVtYi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9wcm92aWRlcnMvYnJlYWRjcnVtYi9icmVhZGNydW1iLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUN0RCxPQUFPLEVBQXdCLGFBQWEsRUFBVSxjQUFjLEVBQVUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ2pDLE9BQU8sRUFDSCxhQUFhLElBQUksdUJBQXVCLEVBQ3hDLFlBQVksRUFFWixFQUFFLElBQUksWUFBWSxFQUNsQixPQUFPLEdBQ1YsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQXFCM0YsTUFBTSxPQUFPLGlCQUFpQjtJQUkxQixZQUFvQixNQUFjLEVBQVUsS0FBcUIsRUFBVSxXQUF3QjtRQUEvRSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUYzRixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUduQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxZQUFZLGFBQWEsQ0FBQyxFQUMvQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUN4QixTQUFTLENBQUMsSUFBSSxDQUFDLEVBQ2YsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIs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LEtBQTJCO0lBQ3JELE9BQU8sT0FBTyxLQUFLLEtBQUssVUFBVSxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxTQUFTLHlCQUF5QixDQUFDLEtBQXNCO0lBQ3JELE9BQU8sS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3pFLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLEtBQXNCO0lBQ2pELE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBEYXRhLCBOYXZpZ2F0aW9uRW5kLCBQYXJhbXMsIFBSSU1BUllfT1VUTEVULCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5pbXBvcnQgeyBmbGF0dGVuIH0gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHtcclxuICAgIGNvbWJpbmVMYXRlc3QgYXMgb2JzZXJ2YWJsZUNvbWJpbmVMYXRlc3QsXHJcbiAgICBpc09ic2VydmFibGUsXHJcbiAgICBPYnNlcnZhYmxlLFxyXG4gICAgb2YgYXMgb2JzZXJ2YWJsZU9mLFxyXG4gICAgU3ViamVjdCxcclxufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHNoYXJlUmVwbGF5LCBzdGFydFdpdGgsIHN3aXRjaE1hcCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBEYXRhU2VydmljZSB9IGZyb20gJy4uLy4uL2RhdGEvcHJvdmlkZXJzL2RhdGEuc2VydmljZSc7XHJcblxyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iU3RyaW5nID0gc3RyaW5nO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBCcmVhZGNydW1iTGFiZWxMaW5rUGFpciB7XHJcbiAgICBsYWJlbDogc3RyaW5nO1xyXG4gICAgbGluazogYW55W107XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEJyZWFkY3J1bWJWYWx1ZSA9IEJyZWFkY3J1bWJTdHJpbmcgfCBCcmVhZGNydW1iTGFiZWxMaW5rUGFpciB8IEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyW107XHJcbmV4cG9ydCB0eXBlIEJyZWFkY3J1bWJGdW5jdGlvbiA9IChcclxuICAgIGRhdGE6IERhdGEsXHJcbiAgICBwYXJhbXM6IFBhcmFtcyxcclxuICAgIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSxcclxuKSA9PiBCcmVhZGNydW1iVmFsdWUgfCBPYnNlcnZhYmxlPEJyZWFkY3J1bWJWYWx1ZT47XHJcbmV4cG9ydCB0eXBlIEJyZWFkY3J1bWJEZWZpbml0aW9uID0gQnJlYWRjcnVtYlZhbHVlIHwgQnJlYWRjcnVtYkZ1bmN0aW9uIHwgT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+O1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgQnJlYWRjcnVtYlNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xyXG4gICAgYnJlYWRjcnVtYnMkOiBPYnNlcnZhYmxlPEFycmF5PHsgbGluazogc3RyaW5nIHwgYW55W107IGxhYmVsOiBzdHJpbmcgfT4+O1xyXG4gICAgcHJpdmF0ZSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXI6IFJvdXRlciwgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsIHByaXZhdGUgZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5icmVhZGNydW1icyQgPSB0aGlzLnJvdXRlci5ldmVudHMucGlwZShcclxuICAgICAgICAgICAgZmlsdGVyKGV2ZW50ID0+IGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCksXHJcbiAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSxcclxuICAgICAgICAgICAgc3RhcnRXaXRoKHRydWUpLFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZW5lcmF0ZUJyZWFkY3J1bWJzKHRoaXMucm91dGUucm9vdCkpLFxyXG4gICAgICAgICAgICBzaGFyZVJlcGxheSgxKSxcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xyXG4gICAgICAgIHRoaXMuZGVzdHJveSQuY29tcGxldGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdlbmVyYXRlQnJlYWRjcnVtYnMoXHJcbiAgICAgICAgcm9vdFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcclxuICAgICk6IE9ic2VydmFibGU8QXJyYXk8eyBsaW5rOiBBcnJheTxzdHJpbmcgfCBhbnk+OyBsYWJlbDogc3RyaW5nIH0+PiB7XHJcbiAgICAgICAgY29uc3QgYnJlYWRjcnVtYlBhcnRzID0gdGhpcy5hc3NlbWJsZUJyZWFkY3J1bWJQYXJ0cyhyb290Um91dGUpO1xyXG4gICAgICAgIGNvbnN0IGJyZWFkY3J1bWJPYnNlcnZhYmxlcyQgPSBicmVhZGNydW1iUGFydHMubWFwKFxyXG4gICAgICAgICAgICAoeyB2YWx1ZSQsIHBhdGggfSkgPT5cclxuICAgICAgICAgICAgICAgIHZhbHVlJC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgIG1hcCh2YWx1ZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0JyZWFkY3J1bWJMYWJlbExpbmtQYWlyKHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogdmFsdWUubGFiZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluazogdGhpcy5ub3JtYWxpemVSZWxhdGl2ZUxpbmtzKHZhbHVlLmxpbmssIHBhdGgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0JyZWFkY3J1bWJQYWlyQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUubWFwKHZhbCA9PiAoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiB2YWwubGFiZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluazogdGhpcy5ub3JtYWxpemVSZWxhdGl2ZUxpbmtzKHZhbC5saW5rLCBwYXRoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHZhbHVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6ICcvJyArIHBhdGguam9pbignLycpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgKSBhcyBPYnNlcnZhYmxlPEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyIHwgQnJlYWRjcnVtYkxhYmVsTGlua1BhaXJbXT4sXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG9ic2VydmFibGVDb21iaW5lTGF0ZXN0KGJyZWFkY3J1bWJPYnNlcnZhYmxlcyQpLnBpcGUobWFwKGxpbmtzID0+IGZsYXR0ZW4obGlua3MpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBXYWxrcyB0aGUgcm91dGUgZGVmaW5pdGlvbiB0cmVlIHRvIGFzc2VtYmxlIGFuIGFycmF5IGZyb20gd2hpY2ggdGhlIGJyZWFkY3J1bWJzIGNhbiBiZSBkZXJpdmVkLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzc2VtYmxlQnJlYWRjcnVtYlBhcnRzKFxyXG4gICAgICAgIHJvb3RSb3V0ZTogQWN0aXZhdGVkUm91dGUsXHJcbiAgICApOiBBcnJheTx7IHZhbHVlJDogT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+OyBwYXRoOiBzdHJpbmdbXSB9PiB7XHJcbiAgICAgICAgY29uc3QgYnJlYWRjcnVtYlBhcnRzOiBBcnJheTx7IHZhbHVlJDogT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+OyBwYXRoOiBzdHJpbmdbXSB9PiA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHNlZ21lbnRQYXRoczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICBsZXQgY3VycmVudFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSB8IG51bGwgPSByb290Um91dGU7XHJcbiAgICAgICAgZG8ge1xyXG4gICAgICAgICAgICBjb25zdCBjaGlsZFJvdXRlcyA9IGN1cnJlbnRSb3V0ZS5jaGlsZHJlbjtcclxuICAgICAgICAgICAgY3VycmVudFJvdXRlID0gbnVsbDtcclxuICAgICAgICAgICAgY2hpbGRSb3V0ZXMuZm9yRWFjaCgocm91dGU6IEFjdGl2YXRlZFJvdXRlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocm91dGUub3V0bGV0ID09PSBQUklNQVJZX09VVExFVCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvdXRlU25hcHNob3QgPSByb3V0ZS5zbmFwc2hvdDtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgYnJlYWRjcnVtYkRlZjogQnJlYWRjcnVtYkRlZmluaXRpb24gfCB1bmRlZmluZWQgPVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByb3V0ZS5yb3V0ZUNvbmZpZyAmJiByb3V0ZS5yb3V0ZUNvbmZpZy5kYXRhICYmIHJvdXRlLnJvdXRlQ29uZmlnLmRhdGFbJ2JyZWFkY3J1bWInXTtcclxuICAgICAgICAgICAgICAgICAgICBzZWdtZW50UGF0aHMucHVzaChyb3V0ZVNuYXBzaG90LnVybC5tYXAoc2VnbWVudCA9PiBzZWdtZW50LnBhdGgpLmpvaW4oJy8nKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChicmVhZGNydW1iRGVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0JyZWFkY3J1bWJGdW5jdGlvbihicmVhZGNydW1iRGVmKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWRjcnVtYkRlZiA9IGJyZWFkY3J1bWJEZWYoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm91dGVTbmFwc2hvdC5kYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlU25hcHNob3QucGFyYW1zLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9ic2VydmFibGVWYWx1ZSA9IGlzT2JzZXJ2YWJsZShicmVhZGNydW1iRGVmKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBicmVhZGNydW1iRGVmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG9ic2VydmFibGVPZihicmVhZGNydW1iRGVmKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWRjcnVtYlBhcnRzLnB1c2goeyB2YWx1ZSQ6IG9ic2VydmFibGVWYWx1ZSwgcGF0aDogc2VnbWVudFBhdGhzLnNsaWNlKCkgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRSb3V0ZSA9IHJvdXRlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IHdoaWxlIChjdXJyZW50Um91dGUpO1xyXG5cclxuICAgICAgICByZXR1cm4gYnJlYWRjcnVtYlBhcnRzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQWNjb3VudHMgZm9yIHJlbGF0aXZlIHJvdXRlcyBpbiB0aGUgbGluayBhcnJheSwgaS5lLiBhcnJheXMgd2hvc2UgZmlyc3QgZWxlbWVudCBpcyBlaXRoZXI6XHJcbiAgICAgKiAqIGAuL2AgICAtIHRoaXMgYXBwZW5kcyB0aGUgcmVzdCBvZiB0aGUgbGluayBzZWdtZW50cyB0byB0aGUgY3VycmVudCBhY3RpdmUgcm91dGVcclxuICAgICAqICogYC4uL2AgIC0gdGhpcyByZW1vdmVzIHRoZSBsYXN0IHNlZ21lbnQgb2YgdGhlIGN1cnJlbnQgYWN0aXZlIHJvdXRlLCBhbmQgYXBwZW5kcyB0aGUgbGluayBzZWdtZW50c1xyXG4gICAgICogICAgICAgICAgICB0byB0aGUgcGFyZW50IHJvdXRlLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIG5vcm1hbGl6ZVJlbGF0aXZlTGlua3MobGluazogYW55W10sIHNlZ21lbnRQYXRoczogc3RyaW5nW10pOiBhbnlbXSB7XHJcbiAgICAgICAgY29uc3QgY2xvbmUgPSBsaW5rLnNsaWNlKCk7XHJcbiAgICAgICAgaWYgKGNsb25lWzBdID09PSAnLi8nKSB7XHJcbiAgICAgICAgICAgIGNsb25lWzBdID0gc2VnbWVudFBhdGhzLmpvaW4oJy8nKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNsb25lWzBdID09PSAnLi4vJykge1xyXG4gICAgICAgICAgICBjbG9uZVswXSA9IHNlZ21lbnRQYXRocy5zbGljZSgwLCAtMSkuam9pbignLycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY2xvbmUuZmlsdGVyKHNlZ21lbnQgPT4gc2VnbWVudCAhPT0gJycpO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc0JyZWFkY3J1bWJGdW5jdGlvbih2YWx1ZTogQnJlYWRjcnVtYkRlZmluaXRpb24pOiB2YWx1ZSBpcyBCcmVhZGNydW1iRnVuY3Rpb24ge1xyXG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJztcclxufVxyXG5cclxuZnVuY3Rpb24gaXNCcmVhZGNydW1iTGFiZWxMaW5rUGFpcih2YWx1ZTogQnJlYWRjcnVtYlZhbHVlKTogdmFsdWUgaXMgQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIge1xyXG4gICAgcmV0dXJuIHZhbHVlLmhhc093blByb3BlcnR5KCdsYWJlbCcpICYmIHZhbHVlLmhhc093blByb3BlcnR5KCdsaW5rJyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzQnJlYWRjcnVtYlBhaXJBcnJheSh2YWx1ZTogQnJlYWRjcnVtYlZhbHVlKTogdmFsdWUgaXMgQnJlYWRjcnVtYkxhYmVsTGlua1BhaXJbXSB7XHJcbiAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgaXNCcmVhZGNydW1iTGFiZWxMaW5rUGFpcih2YWx1ZVswXSk7XHJcbn1cclxuIl19