import { Injectable } from '@angular/core';
import { notNullOrUndefined } from '@vendure/common/lib/shared-utils';
import { BehaviorSubject, combineLatest, of } from 'rxjs';
import { map, shareReplay } from 'rxjs/operators';
import { Permission } from '../../common/generated-types';
import * as i0 from "@angular/core";
/**
 * This service is used to define the contents of configurable menus in the application.
 */
export class NavBuilderService {
    constructor() {
        this.sectionBadges = {};
        this.initialNavMenuConfig$ = new BehaviorSubject([]);
        this.addedNavMenuSections = [];
        this.addedNavMenuItems = [];
        this.addedActionBarItems = [];
        this.setupStreams();
    }
    /**
     * Used to define the initial sections and items of the main nav menu.
     */
    defineNavMenuSections(config) {
        this.initialNavMenuConfig$.next(config);
    }
    /**
     * Add a section to the main nav menu. Providing the `before` argument will
     * move the section before any existing section with the specified id. If
     * omitted (or if the id is not found) the section will be appended to the
     * existing set of sections.
     *
     * Providing the `id` of an existing section will replace that section.
     */
    addNavMenuSection(config, before) {
        this.addedNavMenuSections.push({ config, before });
    }
    /**
     * Add a menu item to an existing section specified by `sectionId`. The id of the section
     * can be found by inspecting the DOM and finding the `data-section-id` attribute.
     * Providing the `before` argument will move the item before any existing item with the specified id.
     * If omitted (or if the name is not found) the item will be appended to the
     * end of the section.
     *
     * Providing the `id` of an existing item in that section will replace
     * that item.
     */
    addNavMenuItem(config, sectionId, before) {
        this.addedNavMenuItems.push({ config, sectionId, before });
    }
    /**
     * Adds a button to the ActionBar at the top right of each list or detail view. The locationId can
     * be determined by inspecting the DOM and finding the `<vdr-action-bar>` element and its
     * `data-location-id` attribute.
     */
    addActionBarItem(config) {
        if (!this.addedActionBarItems.find(item => item.id === config.id)) {
            this.addedActionBarItems.push({
                requiresPermission: Permission.Authenticated,
                ...config,
            });
        }
    }
    getRouterLink(config, route) {
        if (typeof config.routerLink === 'function') {
            return config.routerLink(route, config.context);
        }
        if (Array.isArray(config.routerLink)) {
            return config.routerLink;
        }
        return null;
    }
    setupStreams() {
        const sectionAdditions$ = of(this.addedNavMenuSections);
        const itemAdditions$ = of(this.addedNavMenuItems);
        const combinedConfig$ = combineLatest(this.initialNavMenuConfig$, sectionAdditions$).pipe(map(([initialConfig, additions]) => {
            for (const { config, before } of additions) {
                if (!config.requiresPermission) {
                    config.requiresPermission = Permission.Authenticated;
                }
                const existingIndex = initialConfig.findIndex(c => c.id === config.id);
                if (-1 < existingIndex) {
                    initialConfig[existingIndex] = config;
                }
                const beforeIndex = initialConfig.findIndex(c => c.id === before);
                if (-1 < beforeIndex) {
                    if (-1 < existingIndex) {
                        initialConfig.splice(existingIndex, 1);
                    }
                    initialConfig.splice(beforeIndex, 0, config);
                }
                else if (existingIndex === -1) {
                    initialConfig.push(config);
                }
            }
            return initialConfig;
        }), shareReplay(1));
        this.menuConfig$ = combineLatest(combinedConfig$, itemAdditions$).pipe(map(([sections, additionalItems]) => {
            for (const item of additionalItems) {
                const section = sections.find(s => s.id === item.sectionId);
                if (!section) {
                    // eslint-disable-next-line no-console
                    console.error(`Could not add menu item "${item.config.id}", section "${item.sectionId}" does not exist`);
                }
                else {
                    const { config, sectionId, before } = item;
                    const existingIndex = section.items.findIndex(i => i.id === config.id);
                    if (-1 < existingIndex) {
                        section.items[existingIndex] = config;
                    }
                    const beforeIndex = section.items.findIndex(i => i.id === before);
                    if (-1 < beforeIndex) {
                        if (-1 < existingIndex) {
                            section.items.splice(existingIndex, 1);
                        }
                        section.items.splice(beforeIndex, 0, config);
                    }
                    else if (existingIndex === -1) {
                        section.items.push(config);
                    }
                }
            }
            // Aggregate any badges defined for the nav items in each section
            for (const section of sections) {
                const itemBadgeStatuses = section.items
                    .map(i => i.statusBadge)
                    .filter(notNullOrUndefined);
                this.sectionBadges[section.id] = combineLatest(itemBadgeStatuses).pipe(map(badges => {
                    const propagatingBadges = badges.filter(b => b.propagateToSection);
                    if (propagatingBadges.length === 0) {
                        return 'none';
                    }
                    const statuses = propagatingBadges.map(b => b.type);
                    if (statuses.includes('error')) {
                        return 'error';
                    }
                    else if (statuses.includes('warning')) {
                        return 'warning';
                    }
                    else if (statuses.includes('info')) {
                        return 'info';
                    }
                    else {
                        return 'none';
                    }
                }));
            }
            return sections;
        }));
        this.actionBarConfig$ = of(this.addedActionBarItems);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: NavBuilderService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: NavBuilderService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.2", ngImport: i0, type: NavBuilderService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2LWJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvcHJvdmlkZXJzL25hdi1idWlsZGVyL25hdi1idWlsZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN0RSxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sOEJBQThCLENBQUM7O0FBVzFEOztHQUVHO0FBSUgsTUFBTSxPQUFPLGlCQUFpQjtJQWMxQjtRQVhBLGtCQUFhLEdBQTBELEVBQUUsQ0FBQztRQUVsRSwwQkFBcUIsR0FBRyxJQUFJLGVBQWUsQ0FBbUIsRUFBRSxDQUFDLENBQUM7UUFDbEUseUJBQW9CLEdBQXVELEVBQUUsQ0FBQztRQUM5RSxzQkFBaUIsR0FJcEIsRUFBRSxDQUFDO1FBQ0Esd0JBQW1CLEdBQW9CLEVBQUUsQ0FBQztRQUc5QyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gscUJBQXFCLENBQUMsTUFBd0I7UUFDMUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILGlCQUFpQixDQUFDLE1BQXNCLEVBQUUsTUFBZTtRQUNyRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVEOzs7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LENBQUMsRUFBRTt3QkFDbEMsT0FBTyxNQUFNLENBQUM7cUJBQ2pCO3lCQUFNO3dCQUNILE9BQU8sTUFBTSxDQUFDO3FCQUNqQjtnQkFDTCxDQUFDLENBQUMsQ0FDTCxDQUFDO2FBQ0w7WUFFRCxPQUFPLFFBQVEsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FDTCxDQUFDO1FBRUYsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUN6RCxDQUFDOzhHQXBLUSxpQkFBaUI7a0hBQWpCLGlCQUFpQixjQUZkLE1BQU07OzJGQUVULGlCQUFpQjtrQkFIN0IsVUFBVTttQkFBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgbm90TnVsbE9yVW5kZWZpbmVkIH0gZnJvbSAnQHZlbmR1cmUvY29tbW9uL2xpYi9zaGFyZWQtdXRpbHMnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBQZXJtaXNzaW9uIH0gZnJvbSAnLi4vLi4vY29tbW9uL2dlbmVyYXRlZC10eXBlcyc7XHJcblxyXG5pbXBvcnQge1xyXG4gICAgQWN0aW9uQmFyQ29udGV4dCxcclxuICAgIEFjdGlvbkJhckl0ZW0sXHJcbiAgICBOYXZNZW51QmFkZ2VUeXBlLFxyXG4gICAgTmF2TWVudUl0ZW0sXHJcbiAgICBOYXZNZW51U2VjdGlvbixcclxuICAgIFJvdXRlckxpbmtEZWZpbml0aW9uLFxyXG59IGZyb20gJy4vbmF2LWJ1aWxkZXItdHlwZXMnO1xyXG5cclxuLyoqXHJcbiAqIFRoaXMgc2VydmljZSBpcyB1c2VkIHRvIGRlZmluZSB0aGUgY29udGVudHMgb2YgY29uZmlndXJhYmxlIG1lbnVzIGluIHRoZSBhcHBsaWNhdGlvbi5cclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIE5hdkJ1aWxkZXJTZXJ2aWNlIHtcclxuICAgIG1lbnVDb25maWckOiBPYnNlcnZhYmxlPE5hdk1lbnVTZWN0aW9uW10+O1xyXG4gICAgYWN0aW9uQmFyQ29uZmlnJDogT2JzZXJ2YWJsZTxBY3Rpb25CYXJJdGVtW10+O1xyXG4gICAgc2VjdGlvbkJhZGdlczogeyBbc2VjdGlvbklkOiBzdHJpbmddOiBPYnNlcnZhYmxlPE5hdk1lbnVCYWRnZVR5cGU+IH0gPSB7fTtcclxuXHJcbiAgICBwcml2YXRlIGluaXRpYWxOYXZNZW51Q29uZmlnJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmF2TWVudVNlY3Rpb25bXT4oW10pO1xyXG4gICAgcHJpdmF0ZSBhZGRlZE5hdk1lbnVTZWN0aW9uczogQXJyYXk8eyBjb25maWc6IE5hdk1lbnVTZWN0aW9uOyBiZWZvcmU/OiBzdHJpbmcgfT4gPSBbXTtcclxuICAgIHByaXZhdGUgYWRkZWROYXZNZW51SXRlbXM6IEFycmF5PHtcclxuICAgICAgICBjb25maWc6IE5hdk1lbnVJdGVtO1xyXG4gICAgICAgIHNlY3Rpb25JZDogc3RyaW5nO1xyXG4gICAgICAgIGJlZm9yZT86IHN0cmluZztcclxuICAgIH0+ID0gW107XHJcbiAgICBwcml2YXRlIGFkZGVkQWN0aW9uQmFySXRlbXM6IEFjdGlvbkJhckl0ZW1bXSA9IFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuc2V0dXBTdHJlYW1zKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVc2VkIHRvIGRlZmluZSB0aGUgaW5pdGlhbCBzZWN0aW9ucyBhbmQgaXRlbXMgb2YgdGhlIG1haW4gbmF2IG1lbnUuXHJcbiAgICAgKi9cclxuICAgIGRlZmluZU5hdk1lbnVTZWN0aW9ucyhjb25maWc6IE5hdk1lbnVTZWN0aW9uW10pIHtcclxuICAgICAgICB0aGlzLmluaXRpYWxOYXZNZW51Q29uZmlnJC5uZXh0KGNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBZGQgYSBzZWN0aW9uIHRvIHRoZSBtYWluIG5hdiBtZW51LiBQcm92aWRpbmcgdGhlIGBiZWZvcmVgIGFyZ3VtZW50IHdpbGxcclxuICAgICAqIG1vdmUgdGhlIHNlY3Rpb24gYmVmb3JlIGFueSBleGlzdGluZyBzZWN0aW9uIHdpdGggdGhlIHNwZWNpZmllZCBpZC4gSWZcclxuICAgICAqIG9taXR0ZWQgKG9yIGlmIHRoZSBpZCBpcyBub3QgZm91bmQpIHRoZSBzZWN0aW9uIHdpbGwgYmUgYXBwZW5kZWQgdG8gdGhlXHJcbiAgICAgKiBleGlzdGluZyBzZXQgb2Ygc2VjdGlvbnMuXHJcbiAgICAgKlxyXG4gICAgICogUHJvdmlkaW5nIHRoZSBgaWRgIG9mIGFuIGV4aXN0aW5nIHNlY3Rpb24gd2lsbCByZXBsYWNlIHRoYXQgc2VjdGlvbi5cclxuICAgICAqL1xyXG4gICAgYWRkTmF2TWVudVNlY3Rpb24oY29uZmlnOiBOYXZNZW51U2VjdGlvbiwgYmVmb3JlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5hZGRlZE5hdk1lbnVTZWN0aW9ucy5wdXNoKHsgY29uZmlnLCBiZWZvcmUgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBZGQgYSBtZW51IGl0ZW0gdG8gYW4gZXhpc3Rpbmcgc2VjdGlvbiBzcGVjaWZpZWQgYnkgYHNlY3Rpb25JZGAuIFRoZSBpZCBvZiB0aGUgc2VjdGlvblxyXG4gICAgICogY2FuIGJlIGZvdW5kIGJ5IGluc3BlY3RpbmcgdGhlIERPTSBhbmQgZmluZGluZyB0aGUgYGRhdGEtc2VjdGlvbi1pZGAgYXR0cmlidXRlLlxyXG4gICAgICogUHJvdmlkaW5nIHRoZSBgYmVmb3JlYCBhcmd1bWVudCB3aWxsIG1vdmUgdGhlIGl0ZW0gYmVmb3JlIGFueSBleGlzdGluZyBpdGVtIHdpdGggdGhlIHNwZWNpZmllZCBpZC5cclxuICAgICAqIElmIG9taXR0ZWQgKG9yIGlmIHRoZSBuYW1lIGlzIG5vdCBmb3VuZCkgdGhlIGl0ZW0gd2lsbCBiZSBhcHBlbmRlZCB0byB0aGVcclxuICAgICAqIGVuZCBvZiB0aGUgc2VjdGlvbi5cclxuICAgICAqXHJcbiAgICAgKiBQcm92aWRpbmcgdGhlIGBpZGAgb2YgYW4gZXhpc3RpbmcgaXRlbSBpbiB0aGF0IHNlY3Rpb24gd2lsbCByZXBsYWNlXHJcbiAgICAgKiB0aGF0IGl0ZW0uXHJcbiAgICAgKi9cclxuICAgIGFkZE5hdk1lbnVJdGVtKGNvbmZpZzogTmF2TWVudUl0ZW0sIHNlY3Rpb25JZDogc3RyaW5nLCBiZWZvcmU/OiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLmFkZGVkTmF2TWVudUl0ZW1zLnB1c2goeyBjb25maWcsIHNlY3Rpb25JZCwgYmVmb3JlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQWRkcyBhIGJ1dHRvbiB0byB0aGUgQWN0aW9uQmFyIGF0IHRoZSB0b3AgcmlnaHQgb2YgZWFjaCBsaXN0IG9yIGRldGFpbCB2aWV3LiBUaGUgbG9jYXRpb25JZCBjYW5cclxuICAgICAqIGJlIGRldGVybWluZWQgYnkgaW5zcGVjdGluZyB0aGUgRE9NIGFuZCBmaW5kaW5nIHRoZSBgPHZkci1hY3Rpb24tYmFyPmAgZWxlbWVudCBhbmQgaXRzXHJcbiAgICAgKiBgZGF0YS1sb2NhdGlvbi1pZGAgYXR0cmlidXRlLlxyXG4gICAgICovXHJcbiAgICBhZGRBY3Rpb25CYXJJdGVtKGNvbmZpZzogQWN0aW9uQmFySXRlbSkge1xyXG4gICAgICAgIGlmICghdGhpcy5hZGRlZEFjdGlvbkJhckl0ZW1zLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBjb25maWcuaWQpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkZWRBY3Rpb25CYXJJdGVtcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHJlcXVpcmVzUGVybWlzc2lvbjogUGVybWlzc2lvbi5BdXRoZW50aWNhdGVkLFxyXG4gICAgICAgICAgICAgICAgLi4uY29uZmlnLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Um91dGVyTGluayhcclxuICAgICAgICBjb25maWc6IHsgcm91dGVyTGluaz86IFJvdXRlckxpbmtEZWZpbml0aW9uOyBjb250ZXh0OiBBY3Rpb25CYXJDb250ZXh0IH0sXHJcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxyXG4gICAgKTogc3RyaW5nW10gfCBudWxsIHtcclxuICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yb3V0ZXJMaW5rID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb25maWcucm91dGVyTGluayhyb3V0ZSwgY29uZmlnLmNvbnRleHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb25maWcucm91dGVyTGluaykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5yb3V0ZXJMaW5rO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldHVwU3RyZWFtcygpIHtcclxuICAgICAgICBjb25zdCBzZWN0aW9uQWRkaXRpb25zJCA9IG9mKHRoaXMuYWRkZWROYXZNZW51U2VjdGlvbnMpO1xyXG4gICAgICAgIGNvbnN0IGl0ZW1BZGRpdGlvbnMkID0gb2YodGhpcy5hZGRlZE5hdk1lbnVJdGVtcyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbWJpbmVkQ29uZmlnJCA9IGNvbWJpbmVMYXRlc3QodGhpcy5pbml0aWFsTmF2TWVudUNvbmZpZyQsIHNlY3Rpb25BZGRpdGlvbnMkKS5waXBlKFxyXG4gICAgICAgICAgICBtYXAoKFtpbml0aWFsQ29uZmlnLCBhZGRpdGlvbnNdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHsgY29uZmlnLCBiZWZvcmUgfSBvZiBhZGRpdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5yZXF1aXJlc1Blcm1pc3Npb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLnJlcXVpcmVzUGVybWlzc2lvbiA9IFBlcm1pc3Npb24uQXV0aGVudGljYXRlZDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdJbmRleCA9IGluaXRpYWxDb25maWcuZmluZEluZGV4KGMgPT4gYy5pZCA9PT0gY29uZmlnLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoLTEgPCBleGlzdGluZ0luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxDb25maWdbZXhpc3RpbmdJbmRleF0gPSBjb25maWc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJlZm9yZUluZGV4ID0gaW5pdGlhbENvbmZpZy5maW5kSW5kZXgoYyA9PiBjLmlkID09PSBiZWZvcmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGJlZm9yZUluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGV4aXN0aW5nSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxDb25maWcuc3BsaWNlKGV4aXN0aW5nSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxDb25maWcuc3BsaWNlKGJlZm9yZUluZGV4LCAwLCBjb25maWcpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhpc3RpbmdJbmRleCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbENvbmZpZy5wdXNoKGNvbmZpZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGluaXRpYWxDb25maWc7XHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICBzaGFyZVJlcGxheSgxKSxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB0aGlzLm1lbnVDb25maWckID0gY29tYmluZUxhdGVzdChjb21iaW5lZENvbmZpZyQsIGl0ZW1BZGRpdGlvbnMkKS5waXBlKFxyXG4gICAgICAgICAgICBtYXAoKFtzZWN0aW9ucywgYWRkaXRpb25hbEl0ZW1zXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGFkZGl0aW9uYWxJdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlY3Rpb24gPSBzZWN0aW9ucy5maW5kKHMgPT4gcy5pZCA9PT0gaXRlbS5zZWN0aW9uSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghc2VjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYENvdWxkIG5vdCBhZGQgbWVudSBpdGVtIFwiJHtpdGVtLmNvbmZpZy5pZH1cIiwgc2VjdGlvbiBcIiR7aXRlbS5zZWN0aW9uSWR9XCIgZG9lcyBub3QgZXhpc3RgLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgY29uZmlnLCBzZWN0aW9uSWQsIGJlZm9yZSB9ID0gaXRlbTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdJbmRleCA9IHNlY3Rpb24uaXRlbXMuZmluZEluZGV4KGkgPT4gaS5pZCA9PT0gY29uZmlnLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC0xIDwgZXhpc3RpbmdJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvbi5pdGVtc1tleGlzdGluZ0luZGV4XSA9IGNvbmZpZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiZWZvcmVJbmRleCA9IHNlY3Rpb24uaXRlbXMuZmluZEluZGV4KGkgPT4gaS5pZCA9PT0gYmVmb3JlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC0xIDwgYmVmb3JlSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGV4aXN0aW5nSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLml0ZW1zLnNwbGljZShleGlzdGluZ0luZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3Rpb24uaXRlbXMuc3BsaWNlKGJlZm9yZUluZGV4LCAwLCBjb25maWcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nSW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLml0ZW1zLnB1c2goY29uZmlnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyBBZ2dyZWdhdGUgYW55IGJhZGdlcyBkZWZpbmVkIGZvciB0aGUgbmF2IGl0ZW1zIGluIGVhY2ggc2VjdGlvblxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzZWN0aW9uIG9mIHNlY3Rpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbUJhZGdlU3RhdHVzZXMgPSBzZWN0aW9uLml0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoaSA9PiBpLnN0YXR1c0JhZGdlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKG5vdE51bGxPclVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWN0aW9uQmFkZ2VzW3NlY3Rpb24uaWRdID0gY29tYmluZUxhdGVzdChpdGVtQmFkZ2VTdGF0dXNlcykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFwKGJhZGdlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9wYWdhdGluZ0JhZGdlcyA9IGJhZGdlcy5maWx0ZXIoYiA9PiBiLnByb3BhZ2F0ZVRvU2VjdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGFnYXRpbmdCYWRnZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdub25lJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c2VzID0gcHJvcGFnYXRpbmdCYWRnZXMubWFwKGIgPT4gYi50eXBlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXNlcy5pbmNsdWRlcygnZXJyb3InKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnZXJyb3InO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXNlcy5pbmNsdWRlcygnd2FybmluZycpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd3YXJuaW5nJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzZXMuaW5jbHVkZXMoJ2luZm8nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnaW5mbyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlY3Rpb25zO1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB0aGlzLmFjdGlvbkJhckNvbmZpZyQgPSBvZih0aGlzLmFkZGVkQWN0aW9uQmFySXRlbXMpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==