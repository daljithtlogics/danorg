import { marker as _ } from '@biesbjerg/ngx-translate-extract-marker';
import { DEFAULT_CHANNEL_CODE } from '@vendure/common/lib/shared-constants';
import { EMPTY, lastValueFrom, of, switchMap } from 'rxjs';
import { map, mapTo } from 'rxjs/operators';
import { DataService } from '../../data/providers/data.service';
import { ModalService } from '../../providers/modal/modal.service';
import { NotificationService } from '../../providers/notification/notification.service';
import { AssignToChannelDialogComponent } from '../../shared/components/assign-to-channel-dialog/assign-to-channel-dialog.component';
import { DeletionResult } from '../generated-types';
/**
 * @description
 * Resolves to an object containing the Channel code of the given channelId, or if no channelId
 * is supplied, the code of the activeChannel.
 */
export function getChannelCodeFromUserStatus(dataService, channelId) {
    return lastValueFrom(dataService.client.userStatus().mapSingle(({ userStatus }) => {
        const channelCode = userStatus.channels.find(c => c.id === (channelId ?? userStatus.activeChannelId))?.code ??
            'undefined';
        return { channelCode };
    }));
}
/**
 * @description
 * Resolves to `true` if multiple Channels are set up.
 */
export function isMultiChannel(dataService) {
    return lastValueFrom(dataService.client.userStatus().mapSingle(({ userStatus }) => 1 < userStatus.channels.length));
}
/**
 * @description
 * Resolves to `true` if the current active Channel is not the default Channel.
 */
export function currentChannelIsNotDefault(dataService) {
    return lastValueFrom(dataService.client.userStatus().mapSingle(({ userStatus }) => {
        if (userStatus.channels.length === 1) {
            return false;
        }
        const defaultChannelId = userStatus.channels.find(c => c.code === DEFAULT_CHANNEL_CODE)?.id;
        return userStatus.activeChannelId !== defaultChannelId;
    }));
}
/**
 * @description
 * Creates a BulkAction which can be used to delete multiple items.
 */
export function createBulkDeleteAction(config) {
    const bulkDeleteAction = {
        location: config.location,
        label: _('common.delete'),
        icon: 'trash',
        iconClass: 'is-danger',
        requiresPermission: config.requiresPermission,
        onClick: ({ injector, selection, hostComponent, clearSelection }) => {
            const modalService = injector.get(ModalService);
            const dataService = injector.get(DataService);
            const notificationService = injector.get(NotificationService);
            function showModalAndDelete(items, message) {
                const itemNames = items
                    .slice(0, 5)
                    .map(c => config.getItemName(c))
                    .join(', ');
                const nMore = items.length > 5 ? items.length - 5 : 0;
                return modalService
                    .dialog({
                    title: _('common.confirm-bulk-delete'),
                    body: message ? message : nMore ? _('common.list-items-and-n-more') : itemNames,
                    translationVars: { items: itemNames, nMore },
                    buttons: [
                        { type: 'secondary', label: _('common.cancel') },
                        {
                            type: 'danger',
                            label: message ? _('common.force-delete') : _('common.delete'),
                            returnValue: true,
                        },
                    ],
                })
                    .pipe(switchMap(res => res
                    ? config.bulkDelete(dataService, selection.map(c => c.id), message != null)
                    : of([])));
            }
            showModalAndDelete(selection)
                .pipe(switchMap(result => {
                let deletedCount = 0;
                const errors = [];
                let i = 0;
                for (const item of result) {
                    if (item.result === DeletionResult.DELETED) {
                        deletedCount++;
                    }
                    else if (config.shouldRetryItem?.(result[i], selection[i])) {
                        errors.push({ item: selection[i], message: item.message ?? '' });
                    }
                    i++;
                }
                if (0 < errors.length) {
                    return showModalAndDelete(errors.map(e => e.item), errors.map(e => e.message).join('\n')).pipe(map(result2 => {
                        const deletedCount2 = result2.filter(r => r.result === DeletionResult.DELETED).length;
                        return deletedCount + deletedCount2;
                    }));
                }
                else {
                    return of(deletedCount);
                }
            }))
                .subscribe({
                next: deletedCount => {
                    if (deletedCount) {
                        hostComponent.refresh();
                        clearSelection();
                        notificationService.success(_('common.notify-delete-success-with-count'), {
                            count: deletedCount,
                        });
                    }
                    const notDeletedCount = selection.length - deletedCount;
                    if (0 < notDeletedCount && notDeletedCount < selection.length) {
                        notificationService.error(_('common.notify-delete-error-with-count'), {
                            count: notDeletedCount,
                        });
                    }
                    hostComponent.refresh();
                    clearSelection();
                },
                error: err => {
                    notificationService.error(_('common.notify-delete-error'));
                },
            });
        },
    };
    return bulkDeleteAction;
}
export function createBulkAssignToChannelAction(config) {
    const bulkAssignToChannelAction = {
        location: config.location,
        label: _('common.assign-to-channel'),
        icon: 'layers',
        requiresPermission: config.requiresPermission,
        onClick: ({ injector, selection, hostComponent, clearSelection }) => {
            const modalService = injector.get(ModalService);
            const dataService = injector.get(DataService);
            const notificationService = injector.get(NotificationService);
            const itemNames = selection
                .slice(0, 5)
                .map(c => config.getItemName(c))
                .join(', ');
            const nMore = selection.length > 5 ? selection.length - 5 : 0;
            modalService
                .fromComponent(AssignToChannelDialogComponent, {
                size: 'md',
                locals: {
                    itemNames,
                    nMore,
                },
            })
                .pipe(switchMap(result => {
                if (result) {
                    return config
                        .bulkAssignToChannel(dataService, selection.map(c => c.id), result.id)
                        .pipe(mapTo(result));
                }
                else {
                    return EMPTY;
                }
            }))
                .subscribe(result => {
                notificationService.success(_('common.notify-assign-to-channel-success-with-count'), {
                    count: selection.length,
                    channelCode: result.code,
                });
                clearSelection();
            });
        },
    };
    return bulkAssignToChannelAction;
}
export function createBulkRemoveFromChannelAction(config) {
    const bulkRemoveFromChannelAction = {
        location: config.location,
        label: _('common.remove-from-channel'),
        icon: 'layers',
        iconClass: 'is-warning',
        requiresPermission: config.requiresPermission,
        onClick: ({ injector, selection, hostComponent, clearSelection }) => {
            const modalService = injector.get(ModalService);
            const dataService = injector.get(DataService);
            const notificationService = injector.get(NotificationService);
            const activeChannelId$ = dataService.client
                .userStatus()
                .mapSingle(({ userStatus }) => userStatus.activeChannelId);
            function showModalAndDelete(items, message) {
                const itemNames = items
                    .slice(0, 5)
                    .map(c => config.getItemName(c))
                    .join(', ');
                const nMore = items.length > 5 ? items.length - 5 : 0;
                return modalService
                    .dialog({
                    title: _('common.confirm-bulk-remove-from-channel'),
                    body: message ? message : nMore ? _('common.list-items-and-n-more') : itemNames,
                    translationVars: {
                        count: selection.length,
                        items: itemNames,
                        nMore,
                    },
                    size: message ? 'lg' : 'md',
                    buttons: [
                        { type: 'secondary', label: _('common.cancel') },
                        {
                            type: 'danger',
                            label: message ? _('common.force-remove') : _('common.remove'),
                            returnValue: true,
                        },
                    ],
                })
                    .pipe(switchMap(res => res
                    ? activeChannelId$.pipe(switchMap(activeChannelId => activeChannelId
                        ? config.bulkRemoveFromChannel(dataService, selection.map(c => c.id), activeChannelId, message != null)
                        : EMPTY))
                    : EMPTY));
            }
            showModalAndDelete(selection)
                .pipe(switchMap(result => {
                let removedCount = selection.length;
                const errors = [];
                const errorIds = [];
                let i = 0;
                for (const item of result) {
                    const errorMessage = config.isErrorResult
                        ? config.isErrorResult(item)
                        : undefined;
                    if (errorMessage) {
                        errors.push(errorMessage);
                        errorIds.push(selection[i]?.id);
                        removedCount--;
                    }
                    i++;
                }
                if (0 < errorIds.length) {
                    const errorSelection = selection.filter(s => errorIds.includes(s.id));
                    return showModalAndDelete(errorSelection, errors.join('\n')).pipe(map(result2 => {
                        const notRemovedCount = result2.filter(r => {
                            const secondTryErrorMessage = config.isErrorResult
                                ? config.isErrorResult(r)
                                : undefined;
                            return typeof secondTryErrorMessage === 'string';
                        }).length;
                        return selection.length - notRemovedCount;
                    }));
                }
                else {
                    return of(removedCount);
                }
            }), switchMap(removedCount => removedCount
                ? getChannelCodeFromUserStatus(dataService).then(({ channelCode }) => ({
                    channelCode,
                    removedCount,
                }))
                : EMPTY))
                .subscribe(({ removedCount, channelCode }) => {
                if (removedCount) {
                    hostComponent.refresh();
                    clearSelection();
                    notificationService.success(_('common.notify-remove-from-channel-success-with-count'), {
                        count: removedCount,
                        channelCode,
                    });
                }
            });
        },
    };
    return bulkRemoveFromChannelAction;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1hY3Rpb24tdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2NvbW1vbi91dGlsaXRpZXMvYnVsay1hY3Rpb24tdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUU1RSxPQUFPLEVBQUUsS0FBSyxFQUFRLGFBQWEsRUFBYyxFQUFFLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFNUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRWhFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNuRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUN4RixPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxxRkFBcUYsQ0FBQztBQUVySSxPQUFPLEVBQW9CLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXRFOzs7O0dBSUc7QUFDSCxNQUFNLFVBQVUsNEJBQTRCLENBQUMsV0FBd0IsRUFBRSxTQUFrQjtJQUNyRixPQUFPLGFBQWEsQ0FDaEIsV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUU7UUFDekQsTUFBTSxXQUFXLEdBQ2IsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsU0FBUyxJQUFJLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElB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LENBQUM7Z0NBQ3pCLENBQUMsQ0FBQyxTQUFTLENBQUM7NEJBQ2hCLE9BQU8sT0FBTyxxQkFBcUIsS0FBSyxRQUFRLENBQUM7d0JBQ3JELENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQzt3QkFDVixPQUFPLFNBQVMsQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDO29CQUM5QyxDQUFDLENBQUMsQ0FDTCxDQUFDO2lCQUNMO3FCQUFNO29CQUNILE9BQU8sRUFBRSxDQUFDLFlBQVksQ0FBQyxDQUFDO2lCQUMzQjtZQUNMLENBQUMsQ0FBQyxFQUNGLFNBQVMsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUNyQixZQUFZO2dCQUNSLENBQUMsQ0FBQyw0QkFBNEIsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUNqRSxXQUFXO29CQUNYLFlBQVk7aUJBQ2YsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxLQUFLLENBQ2QsQ0FDSjtpQkFDQSxTQUFTLENBQUMsQ0FBQyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFO2dCQUN6QyxJQUFJLFlBQVksRUFBRTtvQkFDZCxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7b0JBQ3hCLGNBQWMsRUFBRSxDQUFDO29CQUNqQixtQkFBbUIsQ0FBQyxPQUFPLENBQ3ZCLENBQUMsQ0FBQyxzREFBc0QsQ0FBQyxFQUN6RDt3QkFDSSxLQUFLLEVBQUUsWUFBWTt3QkFDbkIsV0FBVztxQkFDZCxDQUNKLENBQUM7aUJBQ0w7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUM7S0FDSixDQUFDO0lBQ0YsT0FBTywyQkFBMkIsQ0FBQztBQUN2QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWFya2VyIGFzIF8gfSBmcm9tICdAYmllc2JqZXJnL25neC10cmFuc2xhdGUtZXh0cmFjdC1tYXJrZXInO1xyXG5pbXBvcnQgeyBERUZBVUxUX0NIQU5ORUxfQ09ERSB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvc2hhcmVkLWNvbnN0YW50cyc7XHJcbmltcG9ydCB7IHVuaXF1ZSB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvdW5pcXVlJztcclxuaW1wb3J0IHsgRU1QVFksIGZyb20sIGxhc3RWYWx1ZUZyb20sIE9ic2VydmFibGUsIG9mLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCBtYXBUbyB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IERhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vZGF0YS9wcm92aWRlcnMvZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQnVsa0FjdGlvbiB9IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9idWxrLWFjdGlvbi1yZWdpc3RyeS9idWxrLWFjdGlvbi10eXBlcyc7XHJcbmltcG9ydCB7IE1vZGFsU2VydmljZSB9IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9tb2RhbC9tb2RhbC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9ub3RpZmljYXRpb24vbm90aWZpY2F0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBc3NpZ25Ub0NoYW5uZWxEaWFsb2dDb21wb25lbnQgfSBmcm9tICcuLi8uLi9zaGFyZWQvY29tcG9uZW50cy9hc3NpZ24tdG8tY2hhbm5lbC1kaWFsb2cvYXNzaWduLXRvLWNoYW5uZWwtZGlhbG9nLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEJhc2VMaXN0Q29tcG9uZW50IH0gZnJvbSAnLi4vYmFzZS1saXN0LmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IERlbGV0aW9uUmVzcG9uc2UsIERlbGV0aW9uUmVzdWx0IH0gZnJvbSAnLi4vZ2VuZXJhdGVkLXR5cGVzJztcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogUmVzb2x2ZXMgdG8gYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIENoYW5uZWwgY29kZSBvZiB0aGUgZ2l2ZW4gY2hhbm5lbElkLCBvciBpZiBubyBjaGFubmVsSWRcclxuICogaXMgc3VwcGxpZWQsIHRoZSBjb2RlIG9mIHRoZSBhY3RpdmVDaGFubmVsLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldENoYW5uZWxDb2RlRnJvbVVzZXJTdGF0dXMoZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlLCBjaGFubmVsSWQ/OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBsYXN0VmFsdWVGcm9tKFxyXG4gICAgICAgIGRhdGFTZXJ2aWNlLmNsaWVudC51c2VyU3RhdHVzKCkubWFwU2luZ2xlKCh7IHVzZXJTdGF0dXMgfSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjaGFubmVsQ29kZSA9XHJcbiAgICAgICAgICAgICAgICB1c2VyU3RhdHVzLmNoYW5uZWxzLmZpbmQoYyA9PiBjLmlkID09PSAoY2hhbm5lbElkID8/IHVzZXJTdGF0dXMuYWN0aXZlQ2hhbm5lbElkKSk/LmNvZGUgPz9cclxuICAgICAgICAgICAgICAgICd1bmRlZmluZWQnO1xyXG4gICAgICAgICAgICByZXR1cm4geyBjaGFubmVsQ29kZSB9O1xyXG4gICAgICAgIH0pLFxyXG4gICAgKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEBkZXNjcmlwdGlvblxyXG4gKiBSZXNvbHZlcyB0byBgdHJ1ZWAgaWYgbXVsdGlwbGUgQ2hhbm5lbHMgYXJlIHNldCB1cC5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBpc011bHRpQ2hhbm5lbChkYXRhU2VydmljZTogRGF0YVNlcnZpY2UpIHtcclxuICAgIHJldHVybiBsYXN0VmFsdWVGcm9tKFxyXG4gICAgICAgIGRhdGFTZXJ2aWNlLmNsaWVudC51c2VyU3RhdHVzKCkubWFwU2luZ2xlKCh7IHVzZXJTdGF0dXMgfSkgPT4gMSA8IHVzZXJTdGF0dXMuY2hhbm5lbHMubGVuZ3RoKSxcclxuICAgICk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogUmVzb2x2ZXMgdG8gYHRydWVgIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBDaGFubmVsIGlzIG5vdCB0aGUgZGVmYXVsdCBDaGFubmVsLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGN1cnJlbnRDaGFubmVsSXNOb3REZWZhdWx0KGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSkge1xyXG4gICAgcmV0dXJuIGxhc3RWYWx1ZUZyb20oXHJcbiAgICAgICAgZGF0YVNlcnZpY2UuY2xpZW50LnVzZXJTdGF0dXMoKS5tYXBTaW5nbGUoKHsgdXNlclN0YXR1cyB9KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh1c2VyU3RhdHVzLmNoYW5uZWxzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRDaGFubmVsSWQgPSB1c2VyU3RhdHVzLmNoYW5uZWxzLmZpbmQoYyA9PiBjLmNvZGUgPT09IERFRkFVTFRfQ0hBTk5FTF9DT0RFKT8uaWQ7XHJcbiAgICAgICAgICAgIHJldHVybiB1c2VyU3RhdHVzLmFjdGl2ZUNoYW5uZWxJZCAhPT0gZGVmYXVsdENoYW5uZWxJZDtcclxuICAgICAgICB9KSxcclxuICAgICk7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIENyZWF0ZUJ1bGtEZWxldGVBY3Rpb25Db25maWc8SXRlbVR5cGU+ID0gUGljazxCdWxrQWN0aW9uLCAnbG9jYXRpb24nIHwgJ3JlcXVpcmVzUGVybWlzc2lvbic+ICYge1xyXG4gICAgZ2V0SXRlbU5hbWU6IChpdGVtOiBJdGVtVHlwZSkgPT4gc3RyaW5nO1xyXG4gICAgc2hvdWxkUmV0cnlJdGVtPzogKHJlc3BvbnNlOiBEZWxldGlvblJlc3BvbnNlLCBpdGVtOiBJdGVtVHlwZSkgPT4gYm9vbGVhbjtcclxuICAgIGJ1bGtEZWxldGU6IChcclxuICAgICAgICBkYXRhU2VydmljZTogRGF0YVNlcnZpY2UsXHJcbiAgICAgICAgaWRzOiBzdHJpbmdbXSxcclxuICAgICAgICByZXRyeWluZzogYm9vbGVhbixcclxuICAgICkgPT4gT2JzZXJ2YWJsZTxEZWxldGlvblJlc3BvbnNlW10+O1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEBkZXNjcmlwdGlvblxyXG4gKiBDcmVhdGVzIGEgQnVsa0FjdGlvbiB3aGljaCBjYW4gYmUgdXNlZCB0byBkZWxldGUgbXVsdGlwbGUgaXRlbXMuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQnVsa0RlbGV0ZUFjdGlvbjxJdGVtVHlwZT4oY29uZmlnOiBDcmVhdGVCdWxrRGVsZXRlQWN0aW9uQ29uZmlnPEl0ZW1UeXBlPikge1xyXG4gICAgY29uc3QgYnVsa0RlbGV0ZUFjdGlvbjogQnVsa0FjdGlvbjxhbnksIEJhc2VMaXN0Q29tcG9uZW50PGFueSwgYW55Pj4gPSB7XHJcbiAgICAgICAgbG9jYXRpb246IGNvbmZpZy5sb2NhdGlvbixcclxuICAgICAgICBsYWJlbDogXygnY29tbW9uLmRlbGV0ZScpLFxyXG4gICAgICAgIGljb246ICd0cmFzaCcsXHJcbiAgICAgICAgaWNvbkNsYXNzOiAnaXMtZGFuZ2VyJyxcclxuICAgICAgICByZXF1aXJlc1Blcm1pc3Npb246IGNvbmZpZy5yZXF1aXJlc1Blcm1pc3Npb24sXHJcbiAgICAgICAgb25DbGljazogKHsgaW5qZWN0b3IsIHNlbGVjdGlvbiwgaG9zdENvbXBvbmVudCwgY2xlYXJTZWxlY3Rpb24gfSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtb2RhbFNlcnZpY2UgPSBpbmplY3Rvci5nZXQoTW9kYWxTZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YVNlcnZpY2UgPSBpbmplY3Rvci5nZXQoRGF0YVNlcnZpY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KE5vdGlmaWNhdGlvblNlcnZpY2UpO1xyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gc2hvd01vZGFsQW5kRGVsZXRlKGl0ZW1zOiBJdGVtVHlwZVtdLCBtZXNzYWdlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtTmFtZXMgPSBpdGVtc1xyXG4gICAgICAgICAgICAgICAgICAgIC5zbGljZSgwLCA1KVxyXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoYyA9PiBjb25maWcuZ2V0SXRlbU5hbWUoYykpXHJcbiAgICAgICAgICAgICAgICAgICAgLmpvaW4oJywgJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuTW9yZSA9IGl0ZW1zLmxlbmd0aCA+IDUgPyBpdGVtcy5sZW5ndGggLSA1IDogMDtcclxuICAgICAgICAgICAgICAgIHJldHVybiBtb2RhbFNlcnZpY2VcclxuICAgICAgICAgICAgICAgICAgICAuZGlhbG9nKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF8oJ2NvbW1vbi5jb25maXJtLWJ1bGstZGVsZXRlJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHk6IG1lc3NhZ2UgPyBtZXNzYWdlIDogbk1vcmUgPyBfKCdjb21tb24ubGlzdC1pdGVtcy1hbmQtbi1tb3JlJykgOiBpdGVtTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0aW9uVmFyczogeyBpdGVtczogaXRlbU5hbWVzLCBuTW9yZSB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHR5cGU6ICdzZWNvbmRhcnknLCBsYWJlbDogXygnY29tbW9uLmNhbmNlbCcpIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2RhbmdlcicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG1lc3NhZ2UgPyBfKCdjb21tb24uZm9yY2UtZGVsZXRlJykgOiBfKCdjb21tb24uZGVsZXRlJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVmFsdWU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcChyZXMgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gY29uZmlnLmJ1bGtEZWxldGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uLm1hcChjID0+IGMuaWQpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgIT0gbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG9mKFtdKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBzaG93TW9kYWxBbmREZWxldGUoc2VsZWN0aW9uKVxyXG4gICAgICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkZWxldGVkQ291bnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvcnM6IEFycmF5PHsgaXRlbTogSXRlbVR5cGU7IG1lc3NhZ2U6IHN0cmluZyB9PiA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiByZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnJlc3VsdCA9PT0gRGVsZXRpb25SZXN1bHQuREVMRVRFRCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZWRDb3VudCsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb25maWcuc2hvdWxkUmV0cnlJdGVtPy4ocmVzdWx0W2ldLCBzZWxlY3Rpb25baV0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goeyBpdGVtOiBzZWxlY3Rpb25baV0sIG1lc3NhZ2U6IGl0ZW0ubWVzc2FnZSA/PyAnJyB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoMCA8IGVycm9ycy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzaG93TW9kYWxBbmREZWxldGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLm1hcChlID0+IGUuaXRlbSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLm1hcChlID0+IGUubWVzc2FnZSkuam9pbignXFxuJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKHJlc3VsdDIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWxldGVkQ291bnQyID0gcmVzdWx0Mi5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByID0+IHIucmVzdWx0ID09PSBEZWxldGlvblJlc3VsdC5ERUxFVEVELFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZWRDb3VudCArIGRlbGV0ZWRDb3VudDI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGRlbGV0ZWRDb3VudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoe1xyXG4gICAgICAgICAgICAgICAgICAgIG5leHQ6IGRlbGV0ZWRDb3VudCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWxldGVkQ291bnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RDb21wb25lbnQucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJTZWxlY3Rpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2Uuc3VjY2VzcyhfKCdjb21tb24ubm90aWZ5LWRlbGV0ZS1zdWNjZXNzLXdpdGgtY291bnQnKSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiBkZWxldGVkQ291bnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBub3REZWxldGVkQ291bnQgPSBzZWxlY3Rpb24ubGVuZ3RoIC0gZGVsZXRlZENvdW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoMCA8IG5vdERlbGV0ZWRDb3VudCAmJiBub3REZWxldGVkQ291bnQgPCBzZWxlY3Rpb24ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLmVycm9yKF8oJ2NvbW1vbi5ub3RpZnktZGVsZXRlLWVycm9yLXdpdGgtY291bnQnKSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiBub3REZWxldGVkQ291bnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBob3N0Q29tcG9uZW50LnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJTZWxlY3Rpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLmVycm9yKF8oJ2NvbW1vbi5ub3RpZnktZGVsZXRlLWVycm9yJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgfTtcclxuICAgIHJldHVybiBidWxrRGVsZXRlQWN0aW9uO1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBDcmVhdGVCdWxrQXNzaWduVG9DaGFubmVsQWN0aW9uQ29uZmlnPEl0ZW1UeXBlPiA9IFBpY2s8XHJcbiAgICBCdWxrQWN0aW9uLFxyXG4gICAgJ2xvY2F0aW9uJyB8ICdyZXF1aXJlc1Blcm1pc3Npb24nXHJcbj4gJiB7XHJcbiAgICBnZXRJdGVtTmFtZTogKGl0ZW06IEl0ZW1UeXBlKSA9PiBzdHJpbmc7XHJcbiAgICBidWxrQXNzaWduVG9DaGFubmVsOiAoXHJcbiAgICAgICAgZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlLFxyXG4gICAgICAgIGlkczogc3RyaW5nW10sXHJcbiAgICAgICAgY2hhbm5lbElkOiBzdHJpbmcsXHJcbiAgICApID0+IE9ic2VydmFibGU8QXJyYXk8UGFydGlhbDxJdGVtVHlwZT4+PjtcclxufTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVCdWxrQXNzaWduVG9DaGFubmVsQWN0aW9uPEl0ZW1UeXBlPihcclxuICAgIGNvbmZpZzogQ3JlYXRlQnVsa0Fzc2lnblRvQ2hhbm5lbEFjdGlvbkNvbmZpZzxJdGVtVHlwZT4sXHJcbikge1xyXG4gICAgY29uc3QgYnVsa0Fzc2lnblRvQ2hhbm5lbEFjdGlvbjogQnVsa0FjdGlvbjxhbnksIEJhc2VMaXN0Q29tcG9uZW50PGFueSwgYW55Pj4gPSB7XHJcbiAgICAgICAgbG9jYXRpb246IGNvbmZpZy5sb2NhdGlvbixcclxuICAgICAgICBsYWJlbDogXygnY29tbW9uLmFzc2lnbi10by1jaGFubmVsJyksXHJcbiAgICAgICAgaWNvbjogJ2xheWVycycsXHJcbiAgICAgICAgcmVxdWlyZXNQZXJtaXNzaW9uOiBjb25maWcucmVxdWlyZXNQZXJtaXNzaW9uLFxyXG4gICAgICAgIG9uQ2xpY2s6ICh7IGluamVjdG9yLCBzZWxlY3Rpb24sIGhvc3RDb21wb25lbnQsIGNsZWFyU2VsZWN0aW9uIH0pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbW9kYWxTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KE1vZGFsU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KERhdGFTZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZSA9IGluamVjdG9yLmdldChOb3RpZmljYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3QgaXRlbU5hbWVzID0gc2VsZWN0aW9uXHJcbiAgICAgICAgICAgICAgICAuc2xpY2UoMCwgNSlcclxuICAgICAgICAgICAgICAgIC5tYXAoYyA9PiBjb25maWcuZ2V0SXRlbU5hbWUoYykpXHJcbiAgICAgICAgICAgICAgICAuam9pbignLCAnKTtcclxuICAgICAgICAgICAgY29uc3Qgbk1vcmUgPSBzZWxlY3Rpb24ubGVuZ3RoID4gNSA/IHNlbGVjdGlvbi5sZW5ndGggLSA1IDogMDtcclxuICAgICAgICAgICAgbW9kYWxTZXJ2aWNlXHJcbiAgICAgICAgICAgICAgICAuZnJvbUNvbXBvbmVudChBc3NpZ25Ub0NoYW5uZWxEaWFsb2dDb21wb25lbnQsIHtcclxuICAgICAgICAgICAgICAgICAgICBzaXplOiAnbWQnLFxyXG4gICAgICAgICAgICAgICAgICAgIGxvY2Fsczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5Nb3JlLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25maWdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYnVsa0Fzc2lnblRvQ2hhbm5lbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5tYXAoYyA9PiBjLmlkKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucGlwZShtYXBUbyhyZXN1bHQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2Uuc3VjY2VzcyhfKCdjb21tb24ubm90aWZ5LWFzc2lnbi10by1jaGFubmVsLXN1Y2Nlc3Mtd2l0aC1jb3VudCcpLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiBzZWxlY3Rpb24ubGVuZ3RoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsQ29kZTogcmVzdWx0LmNvZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJTZWxlY3Rpb24oKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGJ1bGtBc3NpZ25Ub0NoYW5uZWxBY3Rpb247XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIENyZWF0ZUJ1bGtSZW1vdmVGcm9tQ2hhbm5lbEFjdGlvbkNvbmZpZzxJdGVtVHlwZSwgUmVtb3ZlUmVzdWx0ID0gUGFydGlhbDxJdGVtVHlwZT4+ID0gUGljazxcclxuICAgIEJ1bGtBY3Rpb24sXHJcbiAgICAnbG9jYXRpb24nIHwgJ3JlcXVpcmVzUGVybWlzc2lvbidcclxuPiAmIHtcclxuICAgIGdldEl0ZW1OYW1lOiAoaXRlbTogSXRlbVR5cGUpID0+IHN0cmluZztcclxuICAgIGJ1bGtSZW1vdmVGcm9tQ2hhbm5lbDogKFxyXG4gICAgICAgIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSxcclxuICAgICAgICBpZHM6IHN0cmluZ1tdLFxyXG4gICAgICAgIGNoYW5uZWxJZDogc3RyaW5nLFxyXG4gICAgICAgIHJldHJ5aW5nOiBib29sZWFuLFxyXG4gICAgKSA9PiBPYnNlcnZhYmxlPFJlbW92ZVJlc3VsdFtdPjtcclxuICAgIC8qKlxyXG4gICAgICogQW4gb3B0aW9uYWwgdGVzdCBvZiB3aGV0aGVyIHRoZSByZW1vdmFsIHN1Y2NlZWRlZCBmb3IgdGhlIGdpdmVuIGl0ZW0uIElmIHRoaXNcclxuICAgICAqIGZ1bmN0aW9uIHJldHVybnMgYSBzdHJpbmcsIHRoYXQgaXMgdGFrZW4gdG8gYmUgYW4gZXJyb3IgbWVzc2FnZSB3aGljaCB3aWxsIGJlXHJcbiAgICAgKiBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIuXHJcbiAgICAgKi9cclxuICAgIGlzRXJyb3JSZXN1bHQ/OiAocmVzdWx0OiBSZW1vdmVSZXN1bHQpID0+IHN0cmluZyB8IHVuZGVmaW5lZDtcclxufTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVCdWxrUmVtb3ZlRnJvbUNoYW5uZWxBY3Rpb248SXRlbVR5cGUsIFJlc3VsdFR5cGUgPSBQYXJ0aWFsPEl0ZW1UeXBlPj4oXHJcbiAgICBjb25maWc6IENyZWF0ZUJ1bGtSZW1vdmVGcm9tQ2hhbm5lbEFjdGlvbkNvbmZpZzxJdGVtVHlwZSwgUmVzdWx0VHlwZT4sXHJcbikge1xyXG4gICAgY29uc3QgYnVsa1JlbW92ZUZyb21DaGFubmVsQWN0aW9uOiBCdWxrQWN0aW9uPGFueSwgQmFzZUxpc3RDb21wb25lbnQ8YW55LCBhbnk+PiA9IHtcclxuICAgICAgICBsb2NhdGlvbjogY29uZmlnLmxvY2F0aW9uLFxyXG4gICAgICAgIGxhYmVsOiBfKCdjb21tb24ucmVtb3ZlLWZyb20tY2hhbm5lbCcpLFxyXG4gICAgICAgIGljb246ICdsYXllcnMnLFxyXG4gICAgICAgIGljb25DbGFzczogJ2lzLXdhcm5pbmcnLFxyXG4gICAgICAgIHJlcXVpcmVzUGVybWlzc2lvbjogY29uZmlnLnJlcXVpcmVzUGVybWlzc2lvbixcclxuICAgICAgICBvbkNsaWNrOiAoeyBpbmplY3Rvciwgc2VsZWN0aW9uLCBob3N0Q29tcG9uZW50LCBjbGVhclNlbGVjdGlvbiB9KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vZGFsU2VydmljZSA9IGluamVjdG9yLmdldChNb2RhbFNlcnZpY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhU2VydmljZSA9IGluamVjdG9yLmdldChEYXRhU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvblNlcnZpY2UgPSBpbmplY3Rvci5nZXQoTm90aWZpY2F0aW9uU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNoYW5uZWxJZCQgPSBkYXRhU2VydmljZS5jbGllbnRcclxuICAgICAgICAgICAgICAgIC51c2VyU3RhdHVzKClcclxuICAgICAgICAgICAgICAgIC5tYXBTaW5nbGUoKHsgdXNlclN0YXR1cyB9KSA9PiB1c2VyU3RhdHVzLmFjdGl2ZUNoYW5uZWxJZCk7XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBzaG93TW9kYWxBbmREZWxldGUoaXRlbXM6IEl0ZW1UeXBlW10sIG1lc3NhZ2U/OiBzdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1OYW1lcyA9IGl0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgLnNsaWNlKDAsIDUpXHJcbiAgICAgICAgICAgICAgICAgICAgLm1hcChjID0+IGNvbmZpZy5nZXRJdGVtTmFtZShjKSlcclxuICAgICAgICAgICAgICAgICAgICAuam9pbignLCAnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5Nb3JlID0gaXRlbXMubGVuZ3RoID4gNSA/IGl0ZW1zLmxlbmd0aCAtIDUgOiAwO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vZGFsU2VydmljZVxyXG4gICAgICAgICAgICAgICAgICAgIC5kaWFsb2coe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXygnY29tbW9uLmNvbmZpcm0tYnVsay1yZW1vdmUtZnJvbS1jaGFubmVsJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHk6IG1lc3NhZ2UgPyBtZXNzYWdlIDogbk1vcmUgPyBfKCdjb21tb24ubGlzdC1pdGVtcy1hbmQtbi1tb3JlJykgOiBpdGVtTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0aW9uVmFyczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHNlbGVjdGlvbi5sZW5ndGgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogaXRlbU5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbk1vcmUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6IG1lc3NhZ2UgPyAnbGcnIDogJ21kJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0eXBlOiAnc2Vjb25kYXJ5JywgbGFiZWw6IF8oJ2NvbW1vbi5jYW5jZWwnKSB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdkYW5nZXInLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBtZXNzYWdlID8gXygnY29tbW9uLmZvcmNlLXJlbW92ZScpIDogXygnY29tbW9uLnJlbW92ZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGFjdGl2ZUNoYW5uZWxJZCQucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoYWN0aXZlQ2hhbm5lbElkID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZUNoYW5uZWxJZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjb25maWcuYnVsa1JlbW92ZUZyb21DaGFubmVsKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb24ubWFwKGMgPT4gYy5pZCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVDaGFubmVsSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlICE9IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogRU1QVFksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IEVNUFRZLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICApLFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHNob3dNb2RhbEFuZERlbGV0ZShzZWxlY3Rpb24pXHJcbiAgICAgICAgICAgICAgICAucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlbW92ZWRDb3VudCA9IHNlbGVjdGlvbi5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3JJZHM6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gY29uZmlnLmlzRXJyb3JSZXN1bHRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGNvbmZpZy5pc0Vycm9yUmVzdWx0KGl0ZW0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3JNZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goZXJyb3JNZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcklkcy5wdXNoKHNlbGVjdGlvbltpXT8uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZWRDb3VudC0tO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgwIDwgZXJyb3JJZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvclNlbGVjdGlvbiA9IHNlbGVjdGlvbi5maWx0ZXIocyA9PiBlcnJvcklkcy5pbmNsdWRlcyhzLmlkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hvd01vZGFsQW5kRGVsZXRlKGVycm9yU2VsZWN0aW9uLCBlcnJvcnMuam9pbignXFxuJykpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKHJlc3VsdDIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RSZW1vdmVkQ291bnQgPSByZXN1bHQyLmZpbHRlcihyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlY29uZFRyeUVycm9yTWVzc2FnZSA9IGNvbmZpZy5pc0Vycm9yUmVzdWx0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjb25maWcuaXNFcnJvclJlc3VsdChyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBzZWNvbmRUcnlFcnJvck1lc3NhZ2UgPT09ICdzdHJpbmcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24ubGVuZ3RoIC0gbm90UmVtb3ZlZENvdW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihyZW1vdmVkQ291bnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlbW92ZWRDb3VudCA9PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkQ291bnRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZ2V0Q2hhbm5lbENvZGVGcm9tVXNlclN0YXR1cyhkYXRhU2VydmljZSkudGhlbigoeyBjaGFubmVsQ29kZSB9KSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbENvZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkQ291bnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBFTVBUWSxcclxuICAgICAgICAgICAgICAgICAgICApLFxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoeyByZW1vdmVkQ291bnQsIGNoYW5uZWxDb2RlIH0pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZENvdW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RDb21wb25lbnQucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclNlbGVjdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLnN1Y2Nlc3MoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfKCdjb21tb24ubm90aWZ5LXJlbW92ZS1mcm9tLWNoYW5uZWwtc3VjY2Vzcy13aXRoLWNvdW50JyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHJlbW92ZWRDb3VudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsQ29kZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgIH07XHJcbiAgICByZXR1cm4gYnVsa1JlbW92ZUZyb21DaGFubmVsQWN0aW9uO1xyXG59XHJcbiJdfQ==